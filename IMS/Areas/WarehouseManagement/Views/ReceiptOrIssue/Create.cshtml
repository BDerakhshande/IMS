@using IMS.Domain.WarehouseManagement.Enums
@using IMS.Models.ProMan
@model ReceiptOrIssueViewModel
@{
    ViewData["Title"] = "ایجاد رسید / حواله / انتقال";
    Layout = "~/Areas/WarehouseManagement/Views/Shared/_MyLayout.cshtml";
}

<style>
    /* هماهنگی Select2 با Bootstrap */
    .select2-container {
        width: 100% !important;
        font-size: 0.85rem;
    }

    .select2-container--bootstrap-5 .select2-selection--single {
        height: 32px;
        padding: 0.25rem 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
    }

    .select2-container--bootstrap-5 .select2-selection__rendered {
        color: #212529;
        line-height: 1.5;
        font-size: 0.82rem;
        padding-right: 30px;
        padding-left: 10px;
    }

    .select2-container--bootstrap-5 .select2-selection__clear {
        right: 8px !important;
        top: 50%;
        transform: translateY(-50%);
    }

    .select2-container--bootstrap-5 .select2-selection__arrow {
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
    }

    /* راست‌چین برای RTL */
    select.form-select[dir="rtl"],
    .select2-container[dir="rtl"] .select2-selection--single {
        direction: rtl;
        text-align: right;
        padding-right: 1rem;
        padding-left: 2rem;
    }

    /* حذف ظاهر پیش‌فرض مرورگر */
    select.form-select,
    select.select2-hidden-accessible {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
    }

    /* جدول فشرده */
    .table-sm-custom {
        font-size: 0.85rem;
    }

        .table-sm-custom .form-select,
        .table-sm-custom .form-control,
        .table-sm-custom .select2-container .select2-selection--single {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            height: auto;
        }

        .table-sm-custom .accordion-button {
            font-size: 0.82rem;
        }

        .table-sm-custom .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }
</style>

<link href="~/lib/bootstrap-5.1.3-dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/lib/select2-bootstrap-5-theme-1.3.0/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<link href="~/lib/select2/css/select2.min.css" rel="stylesheet" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />



<div class="card border-0 shadow-sm" dir="rtl">
    <div class="card-header py-1 d-flex justify-content-between align-items-center" style="background-color: #1a4959; color: white;">
        <div class="d-flex align-items-center">
            <i class="bi bi-plus-circle ms-1"></i>
            <h5 class="mb-0 fw-bold" style="font-size: 0.9rem;">@ViewData["Title"]</h5>
        </div>
    </div>

    <div class="card-body p-2">
        <form asp-action="Create" method="post" id="receiptIssueForm">
            @Html.AntiForgeryToken()
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger small py-2 px-3 mb-3 text-end">
                    <strong class="d-block mb-1">خطا!</strong>
                    @Html.ValidationSummary(true)
                </div>
            }

            <div class="row g-2 mb-3">
                <div class="col-md-3">
                    <label asp-for="DateString" class="form-label fw-bold small text-end w-100">تاریخ</label>
                    <div class="input-group input-group-sm">
                        <input asp-for="DateString" class="form-control persian-datepicker text-end" placeholder="تاریخ را انتخاب کنید" />
                        <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                    </div>
                    <span asp-validation-for="DateString" class="text-danger small d-block text-end"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="DocumentNumber" class="form-label fw-bold small text-end w-100">شماره سند</label>
                    <div class="input-group input-group-sm">
                        <input asp-for="DocumentNumber" class="form-control text-end" placeholder="شماره سند را وارد کنید" />
                        <span class="input-group-text"><i class="bi bi-file-earmark-text"></i></span>
                    </div>
                    <span asp-validation-for="DocumentNumber" class="text-danger small d-block text-end"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="Type" class="form-label fw-bold small text-end w-100">نوع</label>
                    <select asp-for="Type" class="form-select form-select-sm text-end">
                        <option value="">انتخاب کنید...</option>
                        <option value="1">رسید</option>
                        <option value="2">حواله</option>
                        <option value="3">انتقال</option>
                    </select>
                    <span asp-validation-for="Type" class="text-danger small d-block text-end"></span>
                </div>
            </div>

            <hr class="my-3" />
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold text-dark mb-0" style="font-size: 0.9rem;">آیتم‌ها</h6>
                <button type="button" id="addItemBtn" class="btn btn-sm btn-primary hide-on-print">
                    <i class="bi bi-plus-circle ms-1"></i> افزودن آیتم
                </button>
            </div>

            <div class="table-responsive border rounded-3 mb-3">
                <table class="table table-hover table-sm mb-0 table-sm-custom" id="itemsTable">
                    <thead class="table-light" style="font-size: 0.8rem;">
                        <tr class="text-center">
                            <th class="py-2">کالا</th>
                            <th class="py-2">تعداد</th>
                            <th class="py-2">مبدا</th>
                            <th class="py-2">مقصد</th>
                            <th class="py-2">پروژه</th>
                            <th class="py-2">عنوان درخواست</th>
                            <th class="py-2" style="width: 80px;">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.Items.Count; i++)
                        {
                            <tr class="align-middle" data-index="@i">
                                <td>
                                    <div class="accordion" id="productAccordion_@i">
                                        <div class="accordion-item border-0">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#productCollapse_@i" aria-expanded="false" aria-controls="productCollapse_@i">
                                                    انتخاب کالا و مشخصات آن
                                                </button>
                                            </h2>
                                            <div id="productCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#productAccordion_@i">
                                                <div class="accordion-body p-2">
                                                    <select asp-for="Items[i].CategoryId" class="form-select form-select-sm category-select select2 item-select text-end" data-index="@i">
                                                        <option value="">انتخاب دسته‌بندی</option>
                                                        @foreach (var item in ViewBag.Categories as SelectList)
                                                        {
                                                            <option value="@item.Value" selected="@(item.Value == Model.Items[i].CategoryId.ToString())">@item.Text</option>
                                                        }
                                                    </select>
                                                    <select asp-for="Items[i].GroupId" class="form-select form-select-sm group-select select2 item-select mt-2 text-end" data-index="@i">
                                                        <option value="">انتخاب گروه</option>
                                                        @foreach (var group in Model.Items[i].AvailableGroups ?? new List<SelectListItem>())
                                                        {
                                                            <option value="@group.Value" selected="@(group.Value == Model.Items[i].GroupId?.ToString())">@group.Text</option>
                                                        }
                                                    </select>
                                                    <select asp-for="Items[i].StatusId" class="form-select form-select-sm status-select mt-2 text-end" data-index="@i">
                                                        <option value="">انتخاب طبقه</option>
                                                        @foreach (var status in Model.Items[i].AvailableStatuses ?? new List<SelectListItem>())
                                                        {
                                                            <option value="@status.Value" selected="@(status.Value == Model.Items[i].StatusId?.ToString())">@status.Text</option>
                                                        }
                                                    </select>
                                                    <select asp-for="Items[i].ProductId" class="form-select form-select-sm product-select select2 mt-2 text-end" data-index="@i">
                                                        <option value="">انتخاب کالا</option>
                                                        @foreach (var product in Model.Items[i].AvailableProducts ?? new List<SelectListItem>())
                                                        {
                                                            <option value="@product.Value" selected="@(product.Value == Model.Items[i].ProductId.ToString())">@product.Text</option>
                                                        }
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td style="width: 120px;">
                                    <input asp-for="Items[i].Quantity" type="number" min="1" class="form-control form-control-sm text-end" />
                                    <span asp-validation-for="Items[i].Quantity" class="text-danger small d-block mt-1 text-end"></span>
                                </td>
                                <td>
                                    <div class="accordion" id="sourceAccordion_@i">
                                        <div class="accordion-item border-0">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#sourceCollapse_@i" aria-expanded="false" aria-controls="sourceCollapse_@i">
                                                    مشخصات مبدا
                                                </button>
                                            </h2>
                                            <div id="sourceCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#sourceAccordion_@i">
                                                <div class="accordion-body p-2">
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted mb-1 text-end w-100">انبار</label>
                                                        <select asp-for="Items[i].SourceWarehouseId" class="form-select form-select-sm select2 warehouse-select text-end" data-index="@i" data-type="source">
                                                            <option value="">انتخاب انبار</option>
                                                            @foreach (var item in ViewBag.Warehouses as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].SourceWarehouseId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].SourceWarehouseId" class="text-danger small d-block mt-1 text-end"></span>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted mb-1 text-end w-100">قسمت</label>
                                                        <select asp-for="Items[i].SourceZoneId" class="form-select form-select-sm zone-select text-end" data-index="@i" data-type="source">
                                                            <option value="">انتخاب قسمت</option>
                                                            @foreach (var item in ViewBag.Zones as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].SourceZoneId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].SourceZoneId" class="text-danger small d-block mt-1 text-end"></span>
                                                    </div>
                                                    <div>
                                                        <label class="form-label small text-muted mb-1 text-end w-100">بخش</label>
                                                        <select asp-for="Items[i].SourceSectionId" class="form-select form-select-sm section-select text-end" data-type="source">
                                                            <option value="">انتخاب بخش</option>
                                                            @foreach (var item in ViewBag.Sections as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].SourceSectionId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].SourceSectionId" class="text-danger small d-block mt-1 text-end"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="accordion" id="destAccordion_@i">
                                        <div class="accordion-item border-0">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#destCollapse_@i" aria-expanded="false" aria-controls="destCollapse_@i">
                                                    مشخصات مقصد
                                                </button>
                                            </h2>
                                            <div id="destCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#destAccordion_@i">
                                                <div class="accordion-body p-2">
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted mb-1 text-end w-100">انبار</label>
                                                        <select asp-for="Items[i].DestinationWarehouseId" class="form-select form-select-sm select2 warehouse-select text-end" data-index="@i" data-type="destination">
                                                            <option value="">انتخاب انبار</option>
                                                            @foreach (var item in ViewBag.Warehouses as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].DestinationWarehouseId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].DestinationWarehouseId" class="text-danger small d-block mt-1 text-end"></span>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted mb-1 text-end w-100">قسمت</label>
                                                        <select asp-for="Items[i].DestinationZoneId" class="form-select form-select-sm zone-select text-end" data-index="@i" data-type="destination">
                                                            <option value="">انتخاب قسمت</option>
                                                            @foreach (var item in ViewBag.Zones as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].DestinationZoneId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].DestinationZoneId" class="text-danger small d-block mt-1 text-end"></span>
                                                    </div>
                                                    <div>
                                                        <label class="form-label small text-muted mb-1 text-end w-100">بخش</label>
                                                        <select asp-for="Items[i].DestinationSectionId" class="form-select form-select-sm section-select text-end" data-type="destination">
                                                            <option value="">انتخاب بخش</option>
                                                            @foreach (var item in ViewBag.Sections as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].DestinationSectionId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].DestinationSectionId" class="text-danger small d-block mt-1 text-end"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <select asp-for="Items[i].ProjectId" class="form-select form-select-sm select2-project text-end" data-index="@i">
                                        <option value="">انتخاب پروژه...</option>
                                        @foreach (var project in Model.Items[i].AvailableProjects ?? new List<SelectListItem>())
                                        {
                                            <option value="@project.Value" selected="@(project.Value == Model.Items[i].ProjectId?.ToString())">@project.Text</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Items[i].ProjectId" class="text-danger small d-block text-end"></span>
                                </td>
                                <td>
                                    <select asp-for="Items[i].PurchaseRequestId" class="form-select form-select-sm select2-purchase-request text-end" data-index="@i">
                                        <option value="">انتخاب درخواست خرید...</option>
                                        @foreach (var pr in ViewBag.PurchaseRequests as List<SelectListItem> ?? new List<SelectListItem>())
                                        {
                                            <option value="@pr.Value" selected="@(pr.Value == Model.Items[i].PurchaseRequestId?.ToString())">@pr.Text</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Items[i].PurchaseRequestId" class="text-danger small d-block text-end"></span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-1">
                                        <button type="button" class="btn btn-sm btn-icon btn-outline-success rounded-circle hide-on-print save-item" title="ثبت">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-icon btn-outline-danger rounded-circle hide-on-print remove-item" title="حذف">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-start gap-2 mt-3">
                <a asp-action="Index" class="btn btn-sm btn-secondary px-3 hide-on-print">
                    <i class="bi bi-arrow-right-circle ms-1"></i> بازگشت
                </a>
                <button type="submit" class="btn btn-sm btn-success px-3 hide-on-print">
                    <i class="bi bi-check-circle ms-1"></i> ثبت
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="~/lib/select2/js/select2.min.js"></script>
    <script src="~/lib/bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script>


    <script src="/js/MenuJs.js"></script>
    <script>
        const viewBagData = {
            categories: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Categories)),
            groups: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Groups)),
            statuses: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Statuses)),
            products: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Products)),
            warehouses: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Warehouses)),
            zones: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Zones)),
            sections: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Sections)),
            projects: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Projects)),
            purchaseRequests: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.PurchaseRequests))
                };

        $(document).ready(function () {
            // اطمینان از بارگذاری صحیح آکاردئون‌ها
            $('.accordion-button').each(function () {
                $(this).off('click').on('click', function () {
                    const target = $(this).data('bs-target');
                    const collapseInstance = bootstrap.Collapse.getOrCreateInstance(document.querySelector(target));
                    collapseInstance.toggle();
                });
            });

            // راه‌اندازی Select2 برای تمام دراپ‌داون‌ها
            initSelect2($('select.select2'), 'انتخاب کنید');
            initSelect2($('select.select2-project'), 'انتخاب پروژه');
            initSelect2($('select.select2-purchase-request'), 'انتخاب درخواست خرید');
            initSelect2($('select.category-select, select.warehouse-select'), 'جستجو و انتخاب');
        });

        function initSelect2($elements, placeholder) {
            $elements.each(function () {
                const $el = $(this);
                if ($el.hasClass('select2-hidden-accessible')) {
                    $el.select2('destroy');
                }
                $el.select2({
                    theme: 'bootstrap-5',
                    placeholder: placeholder,
                    allowClear: true,
                    dir: 'rtl',
                    language: 'fa',
                    width: '100%',
                    dropdownParent: $el.closest('.accordion-body').length ? $el.closest('.accordion-body') : $(document.body)
                });
            });
        }

        document.getElementById('addItemBtn').addEventListener('click', function () {
            const tableBody = document.querySelector('#itemsTable tbody');
            const rowCount = tableBody.querySelectorAll('tr.align-middle').length;

            const errorRow = `
                        <tr class="validation-row" data-index="${rowCount}" style="display: none;">
                            <td colspan="7">
                                <div class="alert alert-danger error-message-list mb-0"></div>
                            </td>
                        </tr>`;

            const template = `
                        <tr class="align-middle" data-index="${rowCount}">
                            <td>
                                <div class="accordion" id="productAccordion_${rowCount}">
                                    <div class="accordion-item border-0">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#productCollapse_${rowCount}" aria-expanded="false" aria-controls="productCollapse_${rowCount}">
                                                انتخاب کالا و مشخصات آن
                                            </button>
                                        </h2>
                                        <div id="productCollapse_${rowCount}" class="accordion-collapse collapse" data-bs-parent="#productAccordion_${rowCount}">
                                            <div class="accordion-body p-2">
                                                         <label  class="form-label small text-muted mb-1 text-end w-100">دسته بندی</label>
                                                <select name="Items[${rowCount}].CategoryId" class="form-select form-select-sm category-select select2 item-select text-end" data-index="${rowCount}">
                                                    <option value="">انتخاب دسته‌بندی</option>
                                                    ${viewBagData.categories.map(item => `<option value="${item.Value}">${item.Text}</option>`).join('')}
                                                </select>
                                                         <label  class="form-label small text-muted mb-1 text-end w-100">گروه</label>
                                                <select name="Items[${rowCount}].GroupId" class="form-select form-select-sm group-select select2 item-select mt-2 text-end" data-index="${rowCount}">
                                                    <option value="">انتخاب گروه</option>
                                                </select>
                                                         <label  class="form-label small text-muted mb-1 text-end w-100">طبقه</label>
                                                <select name="Items[${rowCount}].StatusId" class="form-select form-select-sm status-select mt-2 text-end" data-index="${rowCount}">
                                                    <option value="">انتخاب طبقه</option>
                                                </select>
                                                         <label  class="form-label small text-muted mb-1 text-end w-100">کالا</label>
                                                <select name="Items[${rowCount}].ProductId" class="form-select form-select-sm product-select select2 mt-2 text-end" data-index="${rowCount}">
                                                    <option value="">انتخاب کالا</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td style="width: 120px;">
                                <input name="Items[${rowCount}].Quantity" type="number" min="1" class="form-control form-control-sm text-end" />
                                <span class="text-danger small d-block mt-1"></span>
                            </td>
                            <td>
                                <div class="accordion" id="sourceAccordion_${rowCount}">
                                    <div class="accordion-item border-0">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#sourceCollapse_${rowCount}" aria-expanded="false" aria-controls="sourceCollapse_${rowCount}">
                                                مشخصات مبدا
                                            </button>
                                        </h2>
                                        <div id="sourceCollapse_${rowCount}" class="accordion-collapse collapse" data-bs-parent="#sourceAccordion_${rowCount}">
                                            <div class="accordion-body p-2">
                                                <div class="mb-2">
                                                    <label class="form-label small text-muted mb-1 text-end w-100">انبار</label>
                                                    <select name="Items[${rowCount}].SourceWarehouseId" class="form-select form-select-sm select2 warehouse-select text-end" data-index="${rowCount}" data-type="source">
                                                        <option value="">انتخاب انبار</option>
                                                        ${viewBagData.warehouses.map(item => `<option value="${item.Value}">${item.Text}</option>`).join('')}
                                                    </select>
                                                    <span class="text-danger small d-block mt-1"></span>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label small text-muted mb-1 text-end w-100">قسمت</label>
                                                    <select name="Items[${rowCount}].SourceZoneId" class="form-select form-select-sm zone-select text-end" data-index="${rowCount}" data-type="source">
                                                        <option value="">انتخاب قسمت</option>
                                                    </select>
                                                    <span class="text-danger small d-block mt-1"></span>
                                                </div>
                                                <div>
                                                    <label class="form-label small text-muted mb-1 text-end w-100">بخش</label>
                                                    <select name="Items[${rowCount}].SourceSectionId" class="form-select form-select-sm section-select text-end" data-type="source">
                                                        <option value="">انتخاب بخش</option>
                                                    </select>
                                                    <span class="text-danger small d-block mt-1"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="accordion" id="destAccordion_${rowCount}">
                                    <div class="accordion-item border-0">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#destCollapse_${rowCount}" aria-expanded="false" aria-controls="destCollapse_${rowCount}">
                                                مشخصات مقصد
                                            </button>
                                        </h2>
                                        <div id="destCollapse_${rowCount}" class="accordion-collapse collapse" data-bs-parent="#destAccordion_${rowCount}">
                                            <div class="accordion-body p-2">
                                                <div class="mb-2">
                                                    <label class="form-label small text-muted mb-1 text-end w-100">انبار</label>
                                                    <select name="Items[${rowCount}].DestinationWarehouseId" class="form-select form-select-sm select2 warehouse-select text-end" data-index="${rowCount}" data-type="destination">
                                                        <option value="">انتخاب انبار</option>
                                                        ${viewBagData.warehouses.map(item => `<option value="${item.Value}">${item.Text}</option>`).join('')}
                                                    </select>
                                                    <span class="text-danger small d-block mt-1"></span>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label small text-muted mb-1 text-end w-100">قسمت</label>
                                                    <select name="Items[${rowCount}].DestinationZoneId" class="form-select form-select-sm zone-select text-end" data-index="${rowCount}" data-type="destination">
                                                        <option value="">انتخاب قسمت</option>
                                                    </select>
                                                    <span class="text-danger small d-block mt-1"></span>
                                                </div>
                                                <div>
                                                    <label class="form-label small text-muted mb-1 text-end w-100">بخش</label>
                                                    <select name="Items[${rowCount}].DestinationSectionId" class="form-select form-select-sm section-select text-end" data-type="destination">
                                                        <option value="">انتخاب بخش</option>
                                                    </select>
                                                    <span class="text-danger small d-block mt-1"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <select name="Items[${rowCount}].ProjectId" class="form-select form-select-sm select2-project text-end" data-index="${rowCount}">
                                    <option value="">انتخاب پروژه...</option>
                                    ${viewBagData.projects.map(item => `<option value="${item.Value}">${item.Text}</option>`).join('')}
                                </select>
                                <span class="text-danger small d-block mt-1"></span>
                            </td>
                            <td>
                                <select name="Items[${rowCount}].PurchaseRequestId" class="form-select form-select-sm select2-purchase-request text-end" data-index="${rowCount}">
                                    <option value="">انتخاب درخواست خرید...</option>
                                    ${viewBagData.purchaseRequests.map(item => `<option value="${item.Value}">${item.Text}</option>`).join('')}
                                </select>
                                <span class="text-danger small d-block mt-1"></span>
                            </td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-1">
                                    <button type="button" class="btn btn-sm btn-icon btn-outline-success rounded-circle hide-on-print save-item" title="ثبت">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-icon btn-outline-danger rounded-circle hide-on-print remove-item" title="حذف">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>`;

            tableBody.insertAdjacentHTML('beforeend', errorRow);
            tableBody.insertAdjacentHTML('beforeend', template);

            setTimeout(() => {
                const newRow = tableBody.querySelector(`tr.align-middle[data-index="${rowCount}"]`);
                initSelect2($(newRow).find('select.select2'), 'انتخاب کنید');
                initSelect2($(newRow).find('select.select2-project'), 'انتخاب پروژه');
                initSelect2($(newRow).find('select.select2-purchase-request'), 'انتخاب درخواست خرید');
                initSelect2($(newRow).find('select.category-select, select.warehouse-select'), 'جستجو و انتخاب');

                // اطمینان از فعال شدن آکاردئون‌های جدید
                $(newRow).find('.accordion-button').each(function () {
                    $(this).off('click').on('click', function () {
                        const target = $(this).data('bs-target');
                        const collapseInstance = bootstrap.Collapse.getOrCreateInstance(document.querySelector(target));
                        collapseInstance.toggle();
                    });
                });
            }, 100);
        });

        $(document).on('change', '.warehouse-select', function () {
            const $this = $(this);
            const index = $this.data('index');
            const type = $this.data('type');
            const warehouseId = $this.val();
            const zoneSelect = $(`select[name="Items[${index}].${type.charAt(0).toUpperCase() + type.slice(1)}ZoneId"]`);
            const sectionSelect = $(`select[name="Items[${index}].${type.charAt(0).toUpperCase() + type.slice(1)}SectionId"]`);

            if (!warehouseId) {
                zoneSelect.prop('disabled', true).empty().append('<option value="">ابتدا انبار را انتخاب کنید</option>');
                sectionSelect.prop('disabled', true).empty().append('<option value="">ابتدا قسمت را انتخاب کنید</option>');
                return;
            }

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetZones',
                type: 'GET',
                data: { warehouseId },
                success: function (zones) {
                    if (zoneSelect.hasClass('select2-hidden-accessible')) {
                        zoneSelect.select2('destroy');
                    }
                    zoneSelect.empty().append('<option value="">انتخاب قسمت</option>');
                    zones.forEach(zone => zoneSelect.append(`<option value="${zone.value}">${zone.text}</option>`));
                    zoneSelect.prop('disabled', false).select2({
                        theme: 'bootstrap-5',
                        placeholder: 'انتخاب قسمت',
                        allowClear: true,
                        dir: 'rtl',
                        dropdownParent: zoneSelect.closest('.accordion-body').length ? zoneSelect.closest('.accordion-body') : $(document.body)
                    });
                    sectionSelect.prop('disabled', true).empty().append('<option value="">ابتدا قسمت را انتخاب کنید</option>');
                },
                error: () => alert('خطا در بارگذاری قسمت‌ها. لطفاً دوباره تلاش کنید.')
            });
        });

        $(document).on('change', '.zone-select', function () {
            const $this = $(this);
            const nameAttr = $this.attr('name');
            const match = nameAttr.match(/Items\[(\d+)\]\.(Source|Destination)ZoneId/);
            if (!match) return;

            const index = match[1];
            const type = match[2].toLowerCase();
            const zoneId = $this.val();
            const sectionSelect = $(`select[name="Items[${index}].${type.charAt(0).toUpperCase() + type.slice(1)}SectionId"]`);

            if (!zoneId) {
                sectionSelect.prop('disabled', true).empty().append('<option value="">ابتدا قسمت را انتخاب کنید</option>');
                return;
            }

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetSections',
                type: 'GET',
                data: { zoneId },
                success: function (sections) {
                    if (sectionSelect.hasClass('select2-hidden-accessible')) {
                        sectionSelect.select2('destroy');
                    }
                    sectionSelect.empty().append('<option value="">انتخاب بخش</option>');
                    sections.forEach(section => sectionSelect.append(`<option value="${section.value}">${section.text}</option>`));
                    sectionSelect.prop('disabled', false).select2({
                        theme: 'bootstrap-5',
                        placeholder: 'انتخاب بخش',
                        allowClear: true,
                        dir: 'rtl',
                        dropdownParent: sectionSelect.closest('.accordion-body').length ? sectionSelect.closest('.accordion-body') : $(document.body)
                    });
                },
                error: () => alert('خطا در بارگذاری بخش‌ها. لطفاً دوباره تلاش کنید.')
            });
        });

        $(document).on('change', '.item-select[name$="CategoryId"]', function () {
            const $this = $(this);
            const index = $this.data('index');
            const categoryId = $this.val();
            const groupSelect = $(`select[name="Items[${index}].GroupId"]`);
            const statusSelect = $(`select[name="Items[${index}].StatusId"]`);
            const productSelect = $(`select[name="Items[${index}].ProductId"]`);

            [groupSelect, statusSelect, productSelect].forEach(select => {
                if (select.hasClass('select2-hidden-accessible')) {
                    select.select2('destroy');
                }
                select.prop('disabled', true).empty().append(`<option value="">${select.attr('name').includes('GroupId') ? 'ابتدا دسته‌بندی را انتخاب کنید' : select.attr('name').includes('StatusId') ? 'ابتدا گروه را انتخاب کنید' : 'ابتدا وضعیت را انتخاب کنید'}</option>`);
            });

            if (!categoryId) return;

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetGroups',
                type: 'GET',
                data: { categoryId },
                success: function (groups) {
                    groupSelect.empty().append('<option value="">انتخاب گروه</option>');
                    groups.forEach(group => groupSelect.append(`<option value="${group.value}">${group.text}</option>`));
                    groupSelect.prop('disabled', false).select2({
                        theme: 'bootstrap-5',
                        placeholder: 'انتخاب گروه',
                        allowClear: true,
                        dir: 'rtl',
                        dropdownParent: groupSelect.closest('.accordion-body').length ? groupSelect.closest('.accordion-body') : $(document.body)
                    });
                },
                error: () => alert('خطا در بارگذاری گروه‌ها. لطفاً دوباره تلاش کنید.')
            });
        });

        $(document).on('change', '.item-select[name$="GroupId"]', function () {
            const $this = $(this);
            const index = $this.data('index');
            const groupId = $this.val();
            const statusSelect = $(`select[name="Items[${index}].StatusId"]`);
            const productSelect = $(`select[name="Items[${index}].ProductId"]`);

            [statusSelect, productSelect].forEach(select => {
                if (select.hasClass('select2-hidden-accessible')) {
                    select.select2('destroy');
                }
                select.prop('disabled', true).empty().append(`<option value="">${select.attr('name').includes('StatusId') ? 'ابتدا گروه را انتخاب کنید' : 'ابتدا وضعیت را انتخاب کنید'}</option>`);
            });

            if (!groupId) return;

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetStatuses',
                type: 'GET',
                data: { groupId },
                success: function (statuses) {
                    statusSelect.empty().append('<option value="">انتخاب وضعیت</option>');
                    statuses.forEach(status => statusSelect.append(`<option value="${status.value}">${status.text}</option>`));
                    statusSelect.prop('disabled', false).select2({
                        theme: 'bootstrap-5',
                        placeholder: 'انتخاب وضعیت',
                        allowClear: true,
                        dir: 'rtl',
                        dropdownParent: statusSelect.closest('.accordion-body').length ? statusSelect.closest('.accordion-body') : $(document.body)
                    });
                },
                error: () => alert('خطا در بارگذاری وضعیت‌ها. لطفاً دوباره تلاش کنید.')
            });
        });

        $(document).on('change', '.status-select', function () {
            const $this = $(this);
            const index = $this.data('index');
            const statusId = $this.val();
            const productSelect = $(`select[name="Items[${index}].ProductId"]`);

            if (productSelect.hasClass('select2-hidden-accessible')) {
                productSelect.select2('destroy');
            }
            productSelect.prop('disabled', true).empty().append('<option value="">ابتدا وضعیت را انتخاب کنید</option>');

            if (!statusId) return;

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetProducts',
                type: 'GET',
                data: { statusId },
                success: function (products) {
                    productSelect.empty().append('<option value="">انتخاب کالا</option>');
                    products.forEach(product => productSelect.append(`<option value="${product.value}">${product.text}</option>`));
                    productSelect.prop('disabled', false).select2({
                        theme: 'bootstrap-5',
                        placeholder: 'انتخاب کالا',
                        allowClear: true,
                        dir: 'rtl',
                        dropdownParent: productSelect.closest('.accordion-body').length ? productSelect.closest('.accordion-body') : $(document.body)
                    });
                },
                error: () => alert('خطا در بارگذاری کالاها. لطفاً دوباره تلاش کنید.')
            });
        });

        $(document).on('click', '.remove-item', function () {
            const $row = $(this).closest('tr.align-middle');
            const index = $row.data('index');
            const $errorRow = $(`tr.validation-row[data-index="${index}"]`);

            $row.find('.select2').each(function () {
                if ($(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2('destroy');
                }
            });

            $row.remove();
            $errorRow.remove();
        });

        $(document).on('click', '.save-item', function () {
            const $row = $(this).closest('tr.align-middle');
            const index = $row.data('index');
            const prefix = 'Items';

            const productId = $row.find(`select[name="${prefix}[${index}].ProductId"]`).val();
            const purchaseRequestId = $row.find(`select[name="${prefix}[${index}].PurchaseRequestId"]`).val();
            const quantity = $row.find(`input[name="${prefix}[${index}].Quantity"]`).val();
            const sourceWarehouseId = $row.find(`select[name="${prefix}[${index}].SourceWarehouseId"]`).val();
            const sourceZoneId = $row.find(`select[name="${prefix}[${index}].SourceZoneId"]`).val();
            const sourceSectionId = $row.find(`select[name="${prefix}[${index}].SourceSectionId"]`).val();
            const destWarehouseId = $row.find(`select[name="${prefix}[${index}].DestinationWarehouseId"]`).val();
            const destZoneId = $row.find(`select[name="${prefix}[${index}].DestinationZoneId"]`).val();
            const destSectionId = $row.find(`select[name="${prefix}[${index}].DestinationSectionId"]`).val();

            let errors = [];
            if (!productId) errors.push('کالا انتخاب نشده است.');
            if (!quantity || parseFloat(quantity) <= 0) errors.push('مقدار باید بزرگ‌تر از صفر باشد.');
            if (!sourceWarehouseId) errors.push('انبار مبدا انتخاب نشده است.');
            if (!sourceZoneId) errors.push('قسمت مبدا انتخاب نشده است.');
            if (!sourceSectionId) errors.push('بخش مبدا انتخاب نشده است.');
            if (!destWarehouseId) errors.push('انبار مقصد انتخاب نشده است.');
            if (!destZoneId) errors.push('قسمت مقصد انتخاب نشده است.');
            if (!destSectionId) errors.push('بخش مقصد انتخاب نشده است.');

            const $errorRow = $(`tr.validation-row[data-index="${index}"]`);
            const $errorBox = $errorRow.find('.error-message-list');

            if (errors.length > 0) {
                $errorBox.html(`<ul>${errors.map(msg => `<li>${msg}</li>`).join('')}</ul>`);
                $errorRow.show();
                return;
            } else {
                $errorBox.empty();
                $errorRow.hide();
            }

            if (!purchaseRequestId) {
                finalizeRow($row, index, prefix);
                return;
            }

            $.get('/WarehouseManagement/ReceiptOrIssue/CheckProductInPurchaseRequest', { productId, purchaseRequestId }, function (response) {
                if (!response.exists) {
                    $errorBox.html('<ul><li>این کالا در درخواست خرید انتخاب شده وجود ندارد.</li></ul>');
                    $errorRow.show();
                    return;
                }
                finalizeRow($row, index, prefix);
            }).fail(() => alert('خطا در ارتباط با سرور.'));
        });

        function finalizeRow($row, index, prefix) {
            const categoryText = $row.find(`select[name="${prefix}[${index}].CategoryId"] option:selected`).text();
            const groupText = $row.find(`select[name="${prefix}[${index}].GroupId"] option:selected`).text();
            const statusText = $row.find(`select[name="${prefix}[${index}].StatusId"] option:selected`).text();
            const productText = $row.find(`select[name="${prefix}[${index}].ProductId"] option:selected`).text();
            const productSummary = `${categoryText} / ${groupText} / ${statusText} / ${productText}`;

            const sourceWarehouseText = $row.find(`select[name="${prefix}[${index}].SourceWarehouseId"] option:selected`).text();
            const sourceZoneText = $row.find(`select[name="${prefix}[${index}].SourceZoneId"] option:selected`).text();
            const sourceSectionText = $row.find(`select[name="${prefix}[${index}].SourceSectionId"] option:selected`).text();
            const sourceSummary = `${sourceWarehouseText} / ${sourceZoneText} / ${sourceSectionText}`;

            const destWarehouseText = $row.find(`select[name="${prefix}[${index}].DestinationWarehouseId"] option:selected`).text();
            const destZoneText = $row.find(`select[name="${prefix}[${index}].DestinationZoneId"] option:selected`).text();
            const destSectionText = $row.find(`select[name="${prefix}[${index}].DestinationSectionId"] option:selected`).text();
            const destSummary = `${destWarehouseText} / ${destZoneText} / ${destSectionText}`;

            const $productCollapse = $row.find(`#productCollapse_${index}`);
            const $productHeader = $productCollapse.siblings('.accordion-header').find('.accordion-button');
            $productHeader.html(productSummary);
            bootstrap.Collapse.getOrCreateInstance($productCollapse[0]).hide();

            const $sourceCollapse = $row.find(`#sourceCollapse_${index}`);
            const $sourceHeader = $sourceCollapse.siblings('.accordion-header').find('.accordion-button');
            $sourceHeader.html(sourceSummary);
            bootstrap.Collapse.getOrCreateInstance($sourceCollapse[0]).hide();

            const $destCollapse = $row.find(`#destCollapse_${index}`);
            const $destHeader = $destCollapse.siblings('.accordion-header').find('.accordion-button');
            $destHeader.html(destSummary);
            bootstrap.Collapse.getOrCreateInstance($destCollapse[0]).hide();
        }

        $('#receiptIssueForm').submit(function (e) {
            e.preventDefault();
            const form = this;
            $.ajax({
                url: $(form).attr('action'),
                type: 'POST',
                data: new FormData(form),
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        if (confirm('سند با موفقیت ذخیره شد. آیا می‌خواهید فایل PDF سند را دریافت کنید؟')) {
                            window.location.href = `/WarehouseManagement/ReceiptOrIssue/Print/${response.documentId}`;
                        } else {
                            window.location.href = '/WarehouseManagement/ReceiptOrIssue/Index';
                        }
                    } else {
                        alert('خطا:\n' + (response.errors || []).join('\n'));
                    }
                },
                error: () => alert('خطا در ارسال اطلاعات به سرور.')
            });
        });
    </script>
}