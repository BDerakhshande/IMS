@using IMS.Domain.WarehouseManagement.Enums
@using IMS.Models.ProMan
@model ReceiptOrIssueViewModel
@{
    ViewData["Title"] = "ایجاد رسید / حواله";
}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="/css/CreateReceiptOrIssue.css" rel="stylesheet" />

<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h3 class="card-title mb-0">@ViewData["Title"]</h3>
    </div>
    <div class="card-body">
        <form asp-action="Create" method="post" id="receiptIssueForm">
            @Html.AntiForgeryToken()
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    <strong>خطا!</strong>
                    @Html.ValidationSummary(true)
                </div>
            }
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="DateString" class="form-label fw-bold">تاریخ</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                            <input asp-for="DateString" class="form-control persian-datepicker" placeholder="تاریخ را انتخاب کنید" />
                        </div>
                        <span asp-validation-for="DateString" class="text-danger small"></span>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="DocumentNumber" class="form-label fw-bold">شماره سند</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-file-earmark-text"></i></span>
                            <input asp-for="DocumentNumber" class="form-control" placeholder="شماره سند را وارد کنید" />
                        </div>
                        <span asp-validation-for="DocumentNumber" class="text-danger small"></span>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="Type" class="form-label fw-bold">نوع</label>
                        <select asp-for="Type" class="form-select select2">
                            <option value="">انتخاب کنید...</option>
                            <option value="1">رسید</option>
                            <option value="2">حواله</option>
                            <option value="3">انتقال</option>
                        </select>
                        <span asp-validation-for="Type" class="text-danger small"></span>
                    </div>
                </div>

                <!-- پروژه را هم داخل همین ردیف قرار دهید -->
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="ProjectId" class="form-label fw-bold">پروژه</label>
                        <select asp-for="ProjectId" class="form-select select2">
                            <option value="">انتخاب پروژه...</option>
                            @foreach (var item in ViewBag.Projects as SelectList)
                            {
                                <option value="@item.Value" selected="@(item.Value == Model.ProjectId?.ToString())">@item.Text</option>
                            }
                        </select>
                        <span asp-validation-for="ProjectId" class="text-danger small"></span>
                    </div>
                </div>
            </div>

            <hr class="my-4" />
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0 text-dark fw-bold">آیتم‌ها</h4>
                <button type="button" id="addItemBtn" class="btn btn-primary rounded-pill hide-on-print">
                    <i class="bi bi-plus-circle me-2 "></i>افزودن آیتم
                </button>
            </div>
            <div class="table-responsive border rounded-3">
                <table class="table table-hover mb-0" id="itemsTable">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center py-3">کالا</th>
                            <th class="text-center py-3">تعداد</th>
                            <th class="text-center py-3">مبدا</th>
                            <th class="text-center py-3">مقصد</th>
                            <th class="text-center py-3" style="width: 80px;">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.Items.Count; i++)
                        {
                            <tr class="align-middle">
                                <td>
                                    <div class="accordion" id="productAccordion_@i">
                                        <div class="accordion-item border-0">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#productCollapse_@i">
                                                    انتخاب کالا و مشخصات آن
                                                </button>
                                            </h2>
                                            <div id="productCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#productAccordion_@i">
                                                <div class="accordion-body p-2">
                                                    <select asp-for="Items[i].CategoryId" class="form-select category-select select2 shadow-sm item-select" data-index="@i">
                                                        <option value="">انتخاب دسته‌بندی</option>
                                                        @foreach (var item in ViewBag.Categories as SelectList)
                                                        {
                                                            <option value="@item.Value" selected="@(item.Value == Model.Items[i].CategoryId.ToString())">@item.Text</option>
                                                        }
                                                    </select>
                                                    <select asp-for="Items[i].GroupId" class="form-select group-select select2 shadow-sm item-select" data-index="@i">
                                                        <option value="">انتخاب گروه</option>
                                                        @foreach (var group in Model.Items[i].AvailableGroups ?? new List<SelectListItem>())
                                                        {
                                                            <option value="@group.Value" selected="@(group.Value == Model.Items[i].GroupId?.ToString())">@group.Text</option>
                                                        }
                                                    </select>
                                                    <select asp-for="Items[i].StatusId" class="form-select status-select mb-2" data-index="@i">
                                                        <option value="">انتخاب وضعیت</option>
                                                        @foreach (var status in Model.Items[i].AvailableStatuses ?? new List<SelectListItem>())
                                                        {
                                                            <option value="@status.Value" selected="@(status.Value == Model.Items[i].StatusId?.ToString())">@status.Text</option>
                                                        }
                                                    </select>
                                                    <select asp-for="Items[i].ProductId" class="form-select product-select select2 shadow-sm" data-index="@i">
                                                        <option value="">انتخاب کالا</option>
                                                        @foreach (var product in Model.Items[i].AvailableProducts ?? new List<SelectListItem>())
                                                        {
                                                            <option value="@product.Value" selected="@(product.Value == Model.Items[i].ProductId.ToString())">@product.Text</option>
                                                        }
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td style="width: 120px;">
                                    <input asp-for="Items[i].Quantity" type="number" min="1" class="form-control shadow-sm no-spinner" />
                                    <span asp-validation-for="Items[i].Quantity" class="text-danger small d-block mt-1"></span>
                                </td>
                                <td>
                                    <div class="accordion" id="sourceAccordion_@i">
                                        <div class="accordion-item border-0">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#sourceCollapse_@i">
                                                    مشخصات مبدا
                                                </button>
                                            </h2>
                                            <div id="sourceCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#sourceAccordion_@i">
                                                <div class="accordion-body p-2">
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted mb-1">انبار</label>
                                                        <select asp-for="Items[i].SourceWarehouseId" class="form-select form-select-sm warehouse-select shadow-sm" data-index="@i" data-type="source">
                                                            <option value="">انتخاب انبار</option>
                                                            @foreach (var item in ViewBag.Warehouses as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].SourceWarehouseId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].SourceWarehouseId" class="text-danger small d-block mt-1"></span>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted mb-1">قسمت</label>
                                                        <select asp-for="@Model.Items[i].SourceZoneId" class="form-select form-select-sm zone-select shadow-sm" data-type="source">
                                                            <option value="">انتخاب قسمت</option>
                                                            @foreach (var item in ViewBag.Zones as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].SourceZoneId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].SourceZoneId" class="text-danger small d-block mt-1-1"></span>
                                                    </div>
                                                    <div>
                                                        <label class="form-label small text-muted mb-1">بخش</label>
                                                        <select asp-for="Items[i].SourceSectionId" class="form-select form-select-sm section-select shadow-sm" data-type="source">
                                                            <option value="">انتخاب بخش</option>
                                                            @foreach (var item in ViewBag.Sections as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].SourceSectionId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].SourceSectionId" class="text-danger small d-block mt-1"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="accordion" id="destAccordion_@i">
                                        <div class="accordion-item border-0">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#destCollapse_@i">
                                                    مشخصات مقصد
                                                </button>
                                            </h2>
                                            <div id="destCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#destAccordion_@i">
                                                <div class="accordion-body p-2">
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted mb-1">انبار</label>
                                                        <select asp-for="Items[i].DestinationWarehouseId" class="form-select form-select-sm warehouse-select shadow-sm" data-index="@i" data-type="destination">
                                                            <option value="">انتخاب انبار</option>
                                                            @foreach (var item in ViewBag.Warehouses as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].DestinationWarehouseId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].DestinationWarehouseId" class="text-danger small d-block mt-1"></span>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small text-muted mb-1">قسمت</label>
                                                        <select asp-for="Items[i].DestinationZoneId" class="form-select form-select-sm zone-select shadow-sm" data-index="@i" data-type="destination">
                                                            <option value="">انتخاب قسمت</option>
                                                            @foreach (var item in ViewBag.Zones as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].DestinationZoneId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].DestinationZoneId" class="text-danger small d-block mt-1"></span>
                                                    </div>
                                                    <div>
                                                        <label class="form-label small text-muted mb-1">بخش</label>
                                                        <select asp-for="Items[i].DestinationSectionId" class="form-select form-select-sm section-select shadow-sm" data-type="destination">
                                                            <option value="">انتخاب بخش</option>
                                                            @foreach (var item in ViewBag.Sections as SelectList)
                                                            {
                                                                <option value="@item.Value" selected="@(item.Value == Model.Items[i].DestinationSectionId?.ToString())">@item.Text</option>
                                                            }
                                                        </select>
                                                        <span asp-validation-for="Items[i].DestinationSectionId" class="text-danger small d-block mt-1"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <button type="button" class="btn btn-outline-success btn-sm save-item rounded-circle hide-on-print" title="ثبت">
                                            <i class="bi bi-check-lg">ثبت</i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-item rounded-circle hide-on-print" title="حذف">
                                            <i class="bi bi-trash">حذف</i>
                                        </button>
                                    </div>
                                </td>

                            </tr>
                        }
                    </tbody>
                </table>
            </div>



            <hr class="my-4" />

            <div class="d-flex justify-content-end gap-2">
                <a asp-action="Index" class="btn btn-secondary px-4 hide-on-print">
                    <i class="bi bi-arrow-right-circle"></i> بازگشت
                </a>
                <button type="submit" class="btn btn-success px-4 hide-on-print">
                    <i class="bi bi-check-circle"></i> ثبت
                </button>
            </div>
        </form>
    </div>
</div>


<link href="~/lib/select2/css/select2.min.css" rel="stylesheet" />
<link href="~/lib/select2-bootstrap5-theme/select2-bootstrap5.min.css" rel="stylesheet" />
<link href="~/lib/persian-datepicker/persian-datepicker.min.css" rel="stylesheet" />
<link href="~/lib/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet" />

<style>


</style>




@section Scripts {


    <script>


        // ارسال داده‌های ViewBag به JS به صورت JSON
        const categories = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Categories));
        const groups = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Groups));
        const statuses = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Statuses));
        const products = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Products));
        const warehouses = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Warehouses));
        const zones = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Zones));
        const sections = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Sections));


                $(document).ready(function () {
            $('.select2').select2({
                theme: 'bootstrap5',
                placeholder: 'انتخاب کنید',
                allowClear: true
            });
        });


        // ساخت گزینه‌ها
        function buildOptions(items) {
            return items.map(item => `<option value="${item.Value}">${item.Text}</option>`).join('');
        }

              document.getElementById('addItemBtn').addEventListener('click', function () {
            const tableBody = document.querySelector('#itemsTable tbody');
            const rowCount = tableBody.querySelectorAll('tr').length;

            const errorRow = `
                <tr class="validation-row" data-index="${rowCount}" style="display: none;">
                    <td colspan="5">
                        <div class="alert alert-danger error-message-list mb-0"></div>
                    </td>
                </tr>`;

            const template = `
                <tr class="align-middle" data-index="${rowCount}">
                    <td>
                        <div class="accordion" id="productAccordion_${rowCount}">
                            <div class="accordion-item border-0">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#productCollapse_${rowCount}">
                                        انتخاب کالا و مشخصات آن
                                    </button>
                                </h2>
                                <div id="productCollapse_${rowCount}" class="accordion-collapse collapse" data-bs-parent="#productAccordion_${rowCount}">
                                    <div class="accordion-body p-2">
                                        <select name="Items[${rowCount}].CategoryId" class="form-select product-select select2 shadow-sm item-select" data-index="${rowCount}">
                                            <option value="">انتخاب دسته‌بندی</option>
                                            ${buildOptions(categories)}
                                        </select>
                                        <select name="Items[${rowCount}].GroupId" class="form-select product-select select2 shadow-sm item-select" data-index="${rowCount}">
                                            <option value="">انتخاب گروه</option>
                                        </select>
                                        <select name="Items[${rowCount}].StatusId" class="form-select status-select mb-2" data-index="${rowCount}">
                                            <option value="">انتخاب وضعیت</option>
                                        </select>
                                        <select name="Items[${rowCount}].ProductId" class="form-select product-select select2 shadow-sm" data-index="${rowCount}">
                                            <option value="">انتخاب کالا</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td style="width: 120px;">
                            <input name="Items[${rowCount}].Quantity" type="number" min="1" class="form-control shadow-sm no-spinner" />
                            <span class="text-danger small d-block mt-1"></span>
                        </td>
                        <td>
                            <div class="accordion" id="sourceAccordion_${rowCount}">
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#sourceCollapse_${rowCount}">
                                            مشخصات مبدا
                                        </button>
                                    </h2>
                                    <div id="sourceCollapse_${rowCount}" class="accordion-collapse collapse" data-bs-parent="#sourceAccordion_${rowCount}">
                                        <div class="accordion-body p-2">
                                            <div class="mb-2">
                                                <label class="form-label small text-muted mb-1">انبار</label>
                                                <select name="Items[${rowCount}].SourceWarehouseId" class="form-select form-select-sm warehouse-select shadow-sm" data-index="${rowCount}" data-type="source">
                                                    <option value="">انتخاب انبار</option>
                                                    ${buildOptions(warehouses)}
                                                </select>
                                                <span class="text-danger small d-block mt-1"></span>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small text-muted mb-1">قسمت</label>
                                                <select name="Items[${rowCount}].SourceZoneId" class="form-select form-select-sm zone-select shadow-sm" data-type="source">
                                                    <option value="">انتخاب قسمت</option>
                                                    ${buildOptions(zones)}
                                                </select>
                                                <span class="text-danger small d-block mt-1"></span>
                                            </div>
                                            <div>
                                                <label class="form-label small text-muted mb-1">بخش</label>
                                                <select name="Items[${rowCount}].SourceSectionId" class="form-select form-select-sm section-select shadow-sm" data-type="source">
                                                    <option value="">انتخاب بخش</option>
                                                    ${buildOptions(sections)}
                                                </select>
                                                <span class="text-danger small d-block mt-1"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="accordion" id="destAccordion_${rowCount}">
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#destCollapse_${rowCount}">
                                            مشخصات مقصد
                                        </button>
                                    </h2>
                                    <div id="destCollapse_${rowCount}" class="accordion-collapse collapse" data-bs-parent="#destAccordion_${rowCount}">
                                        <div class="accordion-body p-2">
                                            <div class="mb-2">
                                                <label class="form-label small text-muted mb-1">انبار</label>
                                                <select name="Items[${rowCount}].DestinationWarehouseId" class="form-select form-select-sm warehouse-select shadow-sm" data-index="${rowCount}" data-type="destination">
                                                    <option value="">انتخاب انبار</option>
                                                    ${buildOptions(warehouses)}
                                                </select>
                                                <span class="text-danger small d-block mt-1"></span>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small text-muted mb-1">قسمت</label>
                                                <select name="Items[${rowCount}].DestinationZoneId" class="form-select form-select-sm zone-select shadow-sm" data-index="${rowCount}" data-type="destination">
                                                    <option value="">انتخاب قسمت</option>
                                                    ${buildOptions(zones)}
                                                </select>
                                                <span class="text-danger small d-block mt-1"></span>
                                            </div>
                                            <div>
                                                <label class="form-label small text-muted mb-1">بخش</label>
                                                <select name="Items[${rowCount}].DestinationSectionId" class="form-select form-select-sm section-select shadow-sm" data-type="destination">
                                                    <option value="">انتخاب بخش</option>
                                                    ${buildOptions(sections)}
                                                </select>
                                                <span class="text-danger small d-block mt-1"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-2">
                                <button type="button" class="btn btn-outline-success btn-sm save-item rounded-circle hide-on-print" title="ثبت">
                                    <i class="bi bi-check-lg">ثبت</i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-item rounded-circle hide-on-print" title="حذف">
                                    <i class="bi bi-trash">حذف</i>
                                </button>
                            </div>
                        </td>
                    </tr>`;

            tableBody.insertAdjacentHTML('beforeend', errorRow); // سپس ردیف خطا
            tableBody.insertAdjacentHTML('beforeend', template); // ابتدا ردیف اصلی

            const newRow = tableBody.querySelector(`tr.align-middle[data-index="${rowCount}"]`);
            const newErrorRow = tableBody.querySelector(`tr.validation-row[data-index="${rowCount}"]`);

            // مقداردهی select2 فقط روی المان‌های جدید
            $(newRow).find('.select2').select2();

            // رویداد حذف فقط روی دکمه جدید
            newRow.querySelector('.remove-item').onclick = function () {
                newRow.remove();
                newErrorRow.remove();
            };
        });

        // مدیریت کلیک روی دکمه "ثبت"
        document.querySelector('#itemsTable').addEventListener('click', function (event) {
            if (event.target.closest('.save-item')) {
                const button = event.target.closest('.save-item');
                const row = button.closest('tr.align-middle');
                const rowIndex = row.dataset.index;
                validateRow(rowIndex);
            }
        });

        // تابع اعتبارسنجی
        function validateRow(rowIndex) {
            const row = document.querySelector(`tr.align-middle[data-index="${rowIndex}"]`);
            const errorRow = document.querySelector(`tr.validation-row[data-index="${rowIndex}"]`);
            const errorMessageList = errorRow.querySelector('.error-message-list');

            let errors = [];

            // بررسی فیلدهای مورد نیاز
            const category = row.querySelector(`select[name="Items[${rowIndex}].CategoryId"]`).value;
            const quantity = row.querySelector(`input[name="Items[${rowIndex}].Quantity"]`).value;
            const sourceWarehouse = row.querySelector(`select[name="Items[${rowIndex}].SourceWarehouseId"]`).value;
            const destWarehouse = row.querySelector(`select[name="Items[${rowIndex}].DestinationWarehouseId"]`).value;

            if (!category) errors.push('دسته‌بندی انتخاب نشده است.');
            if (!quantity || quantity <= 0) errors.push('تعداد باید بیشتر از صفر باشد.');
            if (!sourceWarehouse) errors.push('انبار مبدا انتخاب نشده است.');
            if (!destWarehouse) errors.push('انبار مقصد انتخاب نشده است.');

            // مدیریت نمایش ردیف خطا
            if (errors.length > 0) {
                errorMessageList.innerHTML = errors.map(error => `<p class="mb-0">${error}</p>`).join('');
                errorRow.style.display = 'table-row';
            } else {
                errorMessageList.innerHTML = '';
                errorRow.style.display = 'none';
            }
        }



        $(document).on('change', '.warehouse-select', function () {
            let $this = $(this);
            let index = $this.data('index');
            let type = $this.data('type');
            let warehouseId = $this.val();

            let zoneSelect = $(`select[name="Items[${index}].${capitalize(type)}ZoneId"]`);
            let sectionSelect = $(`select[name="Items[${index}].${capitalize(type)}SectionId"]`);

            if (!warehouseId) {
                zoneSelect.prop('disabled', true).empty().append($('<option>', { value: '', text: 'ابتدا انبار را انتخاب کنید' }));
                sectionSelect.prop('disabled', true).empty().append($('<option>', { value: '', text: 'ابتدا قسمت را انتخاب کنید' }));
                return;
            }

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetZones',
                type: 'GET',
                data: { warehouseId: warehouseId },
                success: function (zones) {
                    if (zoneSelect.hasClass("select2-hidden-accessible")) {
                        zoneSelect.select2('destroy');
                    }
                     console.log("داده‌های zones:", zones);
                    zoneSelect.empty().append($('<option>', { value: '', text: 'انتخاب قسمت' }));
                            zones.forEach(zone => {
            zoneSelect.append($('<option>', { value: zone.value, text: zone.text }));
        });




                    zoneSelect.prop('disabled', false).select2({
                        theme: 'bootstrap5',
                        placeholder: 'انتخاب قسمت',
                        allowClear: true
                    });

                    sectionSelect.prop('disabled', true).empty().append($('<option>', { value: '', text: 'ابتدا قسمت را انتخاب کنید' }));
                },
                error: function () {
                    alert('خطا در بارگذاری قسمت‌ها. لطفاً دوباره تلاش کنید.');
                }
            });
        });

        $(document).on('change', '.zone-select', function () {
            let $this = $(this);
            let nameAttr = $this.attr('name');
            console.log("🔄 zone-select changed:", nameAttr);

            let match = nameAttr.match(/Items\[(\d+)\]\.(Source|Destination)ZoneId/);
            if (!match) {
                console.warn("⚠️ نام المنت با الگوی مورد انتظار مطابقت ندارد:", nameAttr);
                return;
            }

            let index = match[1];
            let type = match[2].toLowerCase();
            let zoneId = $this.val();

            console.log(`📌 index: ${index}, type: ${type}, zoneId: ${zoneId}`);

            let sectionSelect = $(`select[name="Items[${index}].${capitalize(type)}SectionId"]`);
            console.log("🎯 یافتن SectionSelect:", sectionSelect.length ? sectionSelect : "❌ پیدا نشد");

            if (!zoneId) {
                console.log("🚫 zoneId خالی است، غیرفعال‌سازی لیست بخش‌ها");
                sectionSelect.prop('disabled', true).empty().append($('<option>', {
                    value: '',
                    text: 'ابتدا قسمت را انتخاب کنید'
                }));
                return;
            }

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetSections',
                type: 'GET',
                data: { zoneId: zoneId },
                beforeSend: function () {
                    console.log("📡 درخواست ارسال شد به سرور برای zoneId:", zoneId);
                },
                success: function (sections) {
                    console.log("✅ دریافت لیست بخش‌ها:", sections);
                    sectionSelect.empty().append($('<option>', {
                        value: '',
                        text: 'انتخاب بخش'
                    }));
                    sections.forEach(section => {
                        sectionSelect.append($('<option>', {
                            value: section.value,
                            text: section.text
                        }));
                    });
                    sectionSelect.prop('disabled', false).select2({
                        theme: 'bootstrap5',
                        placeholder: 'انتخاب بخش',
                        allowClear: true
                    });
                },
                error: function (xhr, status, error) {
                    console.error("❌ خطا در Ajax:", status, error);
                    alert('خطا در بارگذاری بخش‌ها. لطفاً دوباره تلاش کنید.');
                }
            });
        });







                       // تابع کمکی برای بزرگ کردن حرف اول
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }


                $(document).on('change', '.item-select[name$="CategoryId"]', function () {
            let $this = $(this);
            let index = $this.data('index');
            let categoryId = $this.val();



            let groupSelect = $(`select[name="Items[${index}].GroupId"]`);
            let statusSelect = $(`select[name="Items[${index}].StatusId"]`);
            let productSelect = $(`select[name="Items[${index}].ProductId"]`);

            console.log(`Selectors found: groupSelect=${groupSelect.length}, statusSelect=${statusSelect.length}, productSelect=${productSelect.length}`);

            // Reset dependent dropdowns
            if (groupSelect.length) {
                if (groupSelect.hasClass('select2-hidden-accessible')) {
                    groupSelect.select2('destroy');
                    console.log('🚀 select2 destroyed on groupSelect');
                }
                groupSelect.prop('disabled', true).empty().append($('<option>', {
                    value: '',
                    text: 'ابتدا دسته‌بندی را انتخاب کنید'
                }));
            }

            if (statusSelect.length) {
                if (statusSelect.hasClass('select2-hidden-accessible')) {
                    statusSelect.select2('destroy');
                    console.log('🚀 select2 destroyed on statusSelect');
                }
                statusSelect.prop('disabled', true).empty().append($('<option>', {
                    value: '',
                    text: 'ابتدا گروه را انتخاب کنید'
                }));
            }

            if (productSelect.length) {
                if (productSelect.hasClass('select2-hidden-accessible')) {
                    productSelect.select2('destroy');
                    console.log('🚀 select2 destroyed on productSelect');
                }
                productSelect.prop('disabled', true).empty().append($('<option>', {
                    value: '',
                    text: 'ابتدا وضعیت را انتخاب کنید'
                }));
            }

            if (!categoryId) {
                console.log('⚠️ دسته‌بندی انتخاب نشده، عملیات متوقف شد.');
                return;
            }

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetGroups',
                type: 'GET',
                data: { categoryId: categoryId },
                success: function (groups) {
                    console.log('✅ دریافت گروه‌ها:', groups);

                    if (groupSelect.length) {
                        groupSelect.empty().append($('<option>', {
                            value: '',
                            text: 'انتخاب گروه'
                        }));

                        if (groups && groups.length) {
                            groups.forEach(function (group) {
                                groupSelect.append($('<option>', {
                                    value: group.value,
                                    text: group.text
                                }));
                                console.log(`   افزودن گروه: value=${group.value}, text=${group.text}`);
                            });
                            groupSelect.prop('disabled', false);

                            groupSelect.select2({
                                theme: 'bootstrap5',
                                placeholder: 'انتخاب گروه',
                                allowClear: true
                            });
                            console.log('✔️ لیست گروه‌ها بروزرسانی و select2 فعال شد.');
                        } else {
                            console.log('⚠️ گروهی برای دسته‌بندی انتخاب‌شده یافت نشد.');
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error('❌ خطا در درخواست Ajax دریافت گروه‌ها:', status, error, xhr.responseText);
                    alert('خطا در بارگذاری گروه‌ها. لطفاً دوباره تلاش کنید.');
                }
            });
        });


              $(document).on('change', '.item-select[name$="GroupId"]', function () {
            let $this = $(this);
            let index = $this.data('index');
            let groupId = $this.val();

            console.log(`🔄 GroupId changed: index=${index}, groupId=${groupId}`);

            let statusSelect = $(`select[name="Items[${index}].StatusId"]`);
            let productSelect = $(`select[name="Items[${index}].ProductId"]`);

            // ریست وضعیت و کالا
            if (statusSelect.length) {
                if (statusSelect.hasClass('select2-hidden-accessible')) {
                    statusSelect.select2('destroy');
                }
                statusSelect.prop('disabled', true).empty().append($('<option>', {
                    value: '',
                    text: 'ابتدا گروه را انتخاب کنید'
                }));
            }

            if (productSelect.length) {
                if (productSelect.hasClass('select2-hidden-accessible')) {
                    productSelect.select2('destroy');
                }
                productSelect.prop('disabled', true).empty().append($('<option>', {
                    value: '',
                    text: 'ابتدا وضعیت را انتخاب کنید'
                }));
            }

            if (!groupId) {
                console.log('⚠️ گروه انتخاب نشده، عملیات متوقف شد.');
                return;
            }

            // درخواست برای گرفتن وضعیت‌ها
            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetStatuses',
                type: 'GET',
                data: { groupId: groupId },
                success: function (statuses) {
                    console.log('✅ دریافت وضعیت‌ها:', statuses);

                    statusSelect.empty().append($('<option>', {
                        value: '',
                        text: 'انتخاب وضعیت'
                    }));

                    if (statuses && statuses.length) {
                        statuses.forEach(function (status) {
                            statusSelect.append($('<option>', {
                                value: status.value,
                                text: status.text
                            }));
                        });

                        statusSelect.prop('disabled', false).select2({
                            theme: 'bootstrap5',
                            placeholder: 'انتخاب وضعیت',
                            allowClear: true
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('❌ خطا در درخواست Ajax دریافت وضعیت‌ها:', status, error, xhr.responseText);
                    alert('خطا در بارگذاری وضعیت‌ها. لطفاً دوباره تلاش کنید.');
                }
            });
        });



                $(document).on('change', '.status-select', function () {
            let $this = $(this);
            let index = $this.data('index');
            let statusId = $this.val();

            console.log(`🔄 StatusId changed: index=${index}, statusId=${statusId}`);

            let productSelect = $(`select[name="Items[${index}].ProductId"]`);

            if (productSelect.length) {
                if (productSelect.hasClass('select2-hidden-accessible')) {
                    productSelect.select2('destroy');
                }
                productSelect.prop('disabled', true).empty().append($('<option>', {
                    value: '',
                    text: 'ابتدا وضعیت را انتخاب کنید'
                }));
            }

            if (!statusId) {
                console.log('⚠️ وضعیت انتخاب نشده، عملیات متوقف شد.');
                return;
            }

            $.ajax({
                url: '/WarehouseManagement/ReceiptOrIssue/GetProducts',
                type: 'GET',
                data: { statusId: statusId },
                success: function (products) {
                    console.log('✅ دریافت کالاها:', products);
                    productSelect.empty().append($('<option>', {
                        value: '',
                        text: 'انتخاب کالا'
                    }));
                    if (products && products.length) {
                        products.forEach(function (product) {
                            productSelect.append($('<option>', {
                                value: product.value,
                                text: product.text
                            }));
                        });
                        productSelect.prop('disabled', false).select2({
                            theme: 'bootstrap5',
                            placeholder: 'انتخاب کالا',
                            allowClear: true
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('❌ خطا در درخواست Ajax دریافت کالاها:', status, error, xhr.responseText);
                    alert('خطا در بارگذاری کالاها. لطفاً دوباره تلاش کنید.');
                }
            });
        });




                $(document).on('click', '.remove-item', function () {
            // پیدا کردن نزدیک‌ترین <tr> والد و حذف آن
            $(this).closest('tr').remove();
        });


                $(document).on('click', '.save-item', function () {
            const $row = $(this).closest('tr[data-index]');
            const index = $row.data('index');
            const prefix = 'Items';  // نام prefix ثابت و بدون شرط

            // استخراج مقادیر ورودی مبدا (Source)
            const productId = $row.find(`select[name="${prefix}[${index}].ProductId"]`).val();
            const quantity = $row.find(`input[name="${prefix}[${index}].Quantity"]`).val();
            const warehouseId = $row.find(`select[name="${prefix}[${index}].SourceWarehouseId"]`).val();
            const zoneId = $row.find(`select[name="${prefix}[${index}].SourceZoneId"]`).val();
            const sectionId = $row.find(`select[name="${prefix}[${index}].SourceSectionId"]`).val();

            // اعتبارسنجی فیلدها
            let errorMessages = [];
            if (!productId) errorMessages.push("کالا انتخاب نشده است.");
            if (!quantity || parseFloat(quantity) <= 0) errorMessages.push("مقدار باید بزرگ‌تر از صفر باشد.");
            if (!warehouseId) errorMessages.push("انبار انتخاب نشده است.");
            if (!zoneId) errorMessages.push("قسمت انتخاب نشده است.");
            if (!sectionId) errorMessages.push("بخش انتخاب نشده است.");

            const $errorRow = $(`tr.validation-row[data-index="${index}"]`);
            const $errorBox = $errorRow.find('.error-message-list');

            if (errorMessages.length > 0) {
                $errorBox.html(`<ul>${errorMessages.map(msg => `<li>${msg}</li>`).join('')}</ul>`);
                $errorRow.show();
                return;
            } else {
                $errorBox.empty();
                $errorRow.hide();
            }

            // دریافت متن‌های خلاصه برای کالا
            const categoryText = $row.find(`select[name="${prefix}[${index}].CategoryId"] option:selected`).text();
            const groupText = $row.find(`select[name="${prefix}[${index}].GroupId"] option:selected`).text();
            const statusText = $row.find(`select[name="${prefix}[${index}].StatusId"] option:selected`).text();
            const productText = $row.find(`select[name="${prefix}[${index}].ProductId"] option:selected`).text();

            const productSummary = `${categoryText} / ${groupText} / ${statusText} / ${productText}`;

            // دریافت متن‌های خلاصه برای مکان مبدا (Source)
            const warehouseText = $row.find(`select[name="${prefix}[${index}].SourceWarehouseId"] option:selected`).text();
            const zoneText = $row.find(`select[name="${prefix}[${index}].SourceZoneId"] option:selected`).text();
            const sectionText = $row.find(`select[name="${prefix}[${index}].SourceSectionId"] option:selected`).text();

            const locationSummary = `${warehouseText} / ${zoneText} / ${sectionText}`;

            // بستن آکاردئون کالا و درج خلاصه متن
            const $productCollapse = $row.find(`#productCollapse_${index}`);
            const $productHeader = $productCollapse.siblings('.accordion-header').find('.accordion-button');
            $productHeader.html(productSummary);
            bootstrap.Collapse.getOrCreateInstance($productCollapse[0]).hide();

            // بستن آکاردئون مکان مبدا و درج خلاصه متن
            const $sourceCollapse = $row.find(`#sourceCollapse_${index}`);
            const $sourceHeader = $sourceCollapse.siblings('.accordion-header').find('.accordion-button');
            $sourceHeader.html(locationSummary);
            bootstrap.Collapse.getOrCreateInstance($sourceCollapse[0]).hide();

           
            const warehouseTextDest = $row.find(`select[name="${prefix}[${index}].DestinationWarehouseId"] option:selected`).text();
            const zoneTextDest = $row.find(`select[name="${prefix}[${index}].DestinationZoneId"] option:selected`).text();
            const sectionTextDest = $row.find(`select[name="${prefix}[${index}].DestinationSectionId"] option:selected`).text();
            const locationSummaryDest = `${warehouseTextDest} / ${zoneTextDest} / ${sectionTextDest}`;

            const $destCollapse = $row.find(`#destCollapse_${index}`);
            const $destHeader = $destCollapse.siblings('.accordion-header').find('.accordion-button');
            $destHeader.html(locationSummaryDest);
            bootstrap.Collapse.getOrCreateInstance($destCollapse[0]).hide();
          
        });





                     $('#receiptIssueForm').submit(function (e) {
            e.preventDefault();
            const form = this;
            const formData = new FormData(form);

            $.ajax({
                url: $(form).attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        if (confirm("سند با موفقیت ذخیره شد. آیا می‌خواهید فایل PDF سند را دریافت کنید؟")) {
                            // فرض: سرور response.documentId را برمی‌گرداند
                           window.location.href = `/WarehouseManagement/ReceiptOrIssue/Print/${response.documentId}`;

                        } else {
                            window.location.href = '/ReceiptOrIssue/Index';
                        }

                    } else {
                        alert("خطا:\n" + (response.errors || []).join('\n'));
                    }
                },
                error: function () {
                    alert('خطا در ارسال اطلاعات به سرور.');
                }
            });
        });

    </script>
}
