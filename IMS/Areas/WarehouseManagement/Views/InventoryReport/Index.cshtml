@using System.Text.Json
@model IMS.Application.WarehouseManagement.DTOs.InventoryReportFilterDto

@{
    ViewData["Title"] = "گزارش موجودی انبارها";
    Layout = "~/Areas/WarehouseManagement/Views/Shared/_MyLayout.cshtml";
}
<style>
    /* اضافه کردن فونت اصلی */
    body {
        font-size: 0.9rem;
    }

    /* استایل‌های قبلی با تغییرات جدید */
    select.form-select[dir="rtl"],
    select.form-select.text-end {
        direction: rtl;
        text-align: right;
        padding-right: 1rem;
        padding-left: 2rem;
        background-position: left 0.75rem center !important;
        background-size: 16px 16px;
        background-repeat: no-repeat;
    }

    select.form-select,
    select.select2-hidden-accessible {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
    }

    .table-sm-custom {
        font-size: 0.8rem;
    }

        .table-sm-custom .form-select,
        .table-sm-custom .form-control {
            font-size: 0.8rem;
            padding: 0.2rem 0.4rem;
            height: auto;
        }

        .table-sm-custom label,
        .table-sm-custom .accordion-button {
            font-size: 0.78rem;
        }

        .table-sm-custom .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }

    .card-header {
        padding: 0.4rem 0.8rem;
    }

    .card-body {
        padding: 0.8rem;
    }

    .form-label {
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 0.2rem;
    }

    .btn-xs {
        padding: 0.15rem 0.3rem;
        font-size: 0.7rem;
        line-height: 1.2;
    }

    /* استایل‌های جدید برای دکمه‌های اکشن */
    .action-buttons {
        position: relative;
        margin-bottom: 1rem;
    }

    .action-buttons-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.3rem 0;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 0.8rem;
    }

    .action-buttons-right {
        display: flex;
        gap: 0.5rem;
    }

    /* بهبود ظاهر جدول */
    .table-responsive {
        border-radius: 0.35rem;
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
    }

        .table th {
            font-size: 0.78rem;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
        }

        .table td {
            font-size: 0.78rem;
            padding: 0.4rem 0.75rem;
            vertical-align: middle;
        }

    /* بهبود ظاهر هشدارها */
    .alert {
        font-size: 0.85rem;
        padding: 0.75rem 1rem;
    }

        .alert i {
            font-size: 1.5rem;
        }
</style>
<link href="~/lib/bootstrap-5.1.3-dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/lib/select2-bootstrap-5-theme-1.3.0/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<link href="~/lib/select2/css/select2.min.css" rel="stylesheet" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

<div class="card border-0 shadow-sm" dir="rtl">
    <div class="card-header py-1 d-flex justify-content-between align-items-center" style="background-color: #1a4959; color: white;">
        <div class="d-flex align-items-center">
            <i class="fas fa-warehouse ms-1" style="font-size: 0.85rem;"></i>
            <h5 class="mb-0 fw-bold" style="font-size: 0.9rem;">@ViewData["Title"]</h5>
        </div>
    </div>

    <div class="card-body p-2">
        <form method="post" asp-action="Index" id="inventoryReportForm">
            <!-- فیلترهای انبار -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-light-primary d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-black">
                        <i class="fas fa-warehouse me-2"></i>فیلتر بر اساس انبار
                    </h6>
                </div>
                <div class="card-body">
                    <div id="warehouseFiltersContainer">
                        @for (int i = 0; i < Model.Warehouses.Count; i++)
                        {
                            var warehouse = Model.Warehouses[i];
                            <div class="warehouse-filter-group p-3 border rounded mb-3 shadow-sm">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small">انبار</label>
                                        <select name="Warehouses[@i].WarehouseId" class="form-select form-select-sm select2 shadow-sm" data-index="@i" onchange="loadZones(this)">
                                            <option value="">انتخاب انبار</option>
                                            @foreach (var wh in (SelectList)ViewBag.Warehouses)
                                            {
                                                <option value="@wh.Value" selected="@(wh.Value == warehouse.WarehouseId.ToString())">@wh.Text</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small">قسمت</label>
                                        <select name="Warehouses[@i].ZoneIds" class="form-select form-select-sm select2 shadow-sm" data-index="@i" onchange="loadSections(this)" disabled multiple>
                                            @if (warehouse.ZoneIds != null && warehouse.ZoneIds.Any())
                                            {
                                                @foreach (var zone in (SelectList)ViewBag.Zones)
                                                {
                                                    <option value="@zone.Value" selected="@(warehouse.ZoneIds.Contains(int.Parse(zone.Value)))">@zone.Text</option>
                                                }
                                            }
                                            else
                                            {
                                                <option value="">ابتدا انبار را انتخاب کنید</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small">بخش‌ها</label>
                                        <select name="Warehouses[@i].SectionIds" class="form-select form-select-sm select2 shadow-sm" data-index="@i" disabled multiple>
                                            @if (warehouse.SectionIds != null && warehouse.SectionIds.Any())
                                            {
                                                @foreach (var section in (SelectList)ViewBag.Sections)
                                                {
                                                    <option value="@(section.Value)" selected="@(warehouse.SectionIds.Contains(int.Parse(section.Value)))">@(section.Text)</option>
                                                }
                                            }
                                            else
                                            {
                                                <option value="">ابتدا قسمت را انتخاب کنید</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="text-end mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger rounded-pill" onclick="removeWarehouseFilter(this)">
                                        <i class="fas fa-times me-1"></i> حذف
                                    </button>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- دکمه اضافه کردن انبار جدید -->
                    <div class="text-end mt-3">
                        <button type="button" class="btn btn-sm btn-outline-primary rounded-pill" onclick="addWarehouseFilter()">
                            <i class="fas fa-plus me-1"></i> افزودن انبار دیگر
                        </button>
                    </div>
                </div>
            </div>

            <!-- فیلترهای محصول -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-light-success d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-black">
                        <i class="fas fa-boxes me-2"></i>فیلتر بر اساس کالا
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label class="form-label small">دسته‌بندی</label>
                            <select id="CategoryId" name="CategoryId" class="form-select form-select-sm select2 shadow-sm" onchange="loadGroups(this.value)">
                                <option value="">انتخاب دسته‌بندی</option>
                                @foreach (var category in (SelectList)ViewBag.Categories)
                                {
                                    <option value="@category.Value" selected="@(category.Value == Model.CategoryId?.ToString() ? "selected" : null)">@category.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">گروه</label>
                            <select id="GroupId" name="GroupId" class="form-select form-select-sm select2 shadow-sm" onchange="loadStatuses(this.value)">
                                <option value="">انتخاب گروه</option>
                                @foreach (var group in (SelectList)ViewBag.Groups)
                                {
                                    <option value="@group.Value" selected="@(group.Value == Model.GroupId?.ToString() ? "selected" : null)">@group.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">طبقه</label>
                            <select id="StatusId" name="StatusId" class="form-select form-select-sm select2 shadow-sm" onchange="loadProducts(this.value)" @(ViewBag.Statuses != null ? "" : "disabled")>
                                <option value="">انتخاب طبقه</option>
                                @if (ViewBag.Statuses != null)
                                {
                                    foreach (var status in (SelectList)ViewBag.Statuses)
                                    {
                                        <option value="@status.Value" selected="@(status.Value == Model.StatusId?.ToString() ? "selected" : null)">@status.Text</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">کالا</label>
                            <select id="ProductId" name="ProductId" class="form-select form-select-sm select2 shadow-sm" onchange="loadUniqueCodes(this.value)" @(ViewBag.Products != null ? "" : "disabled")>
                                <option value="">ابتدا طبقه را انتخاب کنید</option>
                                @if (ViewBag.Products != null)
                                {
                                    foreach (var product in (SelectList)ViewBag.Products)
                                    {
                                        <option value="@product.Value" selected="@(product.Value == Model.ProductId?.ToString() ? "selected" : null)">@product.Text</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">کد یکتا</label>
                            <select id="UniqueCodes" name="UniqueCodes" class="form-select form-select-sm select2 shadow-sm" multiple="multiple" disabled>
                                <option value="">ابتدا کالا را انتخاب کنید</option>
                            </select>
                        </div>

                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12 text-center">
                    <button type="submit" class="btn btn-sm btn-primary px-4 rounded-pill">
                        <i class="fas fa-search me-2"></i> جستجو
                    </button>
                    <button type="reset" class="btn btn-sm btn-outline-secondary ms-2 rounded-pill" onclick="resetForm()">
                        <i class="fas fa-undo me-2"></i> بازنشانی
                    </button>
                </div>
            </div>
        </form>
        <form method="post" asp-action="ExportToPdf" id="pdfExportForm" style="display:none;">
            @Html.AntiForgeryToken()

            @Html.HiddenFor(m => m.CategoryId)
            @Html.HiddenFor(m => m.GroupId)
            @Html.HiddenFor(m => m.StatusId)
            @Html.HiddenFor(m => m.ProductId)

            @for (int i = 0; i < Model.Warehouses.Count; i++)
            {
                @Html.HiddenFor(m => m.Warehouses[i].WarehouseId)
                @for (int j = 0; j < Model.Warehouses[i].ZoneIds.Count; j++)
                {
                    @Html.HiddenFor(m => m.Warehouses[i].ZoneIds[j])
                }
                @for (int k = 0; k < Model.Warehouses[i].SectionIds.Count; k++)
                {
                    @Html.HiddenFor(m => m.Warehouses[i].SectionIds[k])
                }
            }
        </form>
    </div>
</div>

@if ((ViewBag.SearchPerformed == true) && Model?.Items != null && Model.Items.Any())
{
    <!-- نمایش جدول گزارشات با چیدمان بهبود یافته -->
    <div class="action-buttons" dir="rtl">
        <div class="action-buttons-container">
            <h6 class="mb-0 fw-bold" style="font-size: 0.85rem;">
                <i class="fas fa-list-alt ms-1"></i> نتایج گزارش
            </h6>
            <div class="action-buttons-right">
                <button type="button" class="btn btn-xs btn-outline-primary rounded-pill" onclick="document.getElementById('pdfExportForm').submit();">
                    <i class="fas fa-file-pdf me-2"></i> پرینت
                </button>
                <button type="button" class="btn btn-xs btn-outline-success rounded-pill" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i> اکسل
                </button>
            </div>
        </div>
    </div>

    <div id="reportResults" class="mt-2" dir="rtl">
        <div class="card shadow-sm">
            <div class="card-header py-1 d-flex justify-content-between align-items-center" style="background-color: #1a4959; color: white;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-boxes ms-1" style="font-size: 0.8rem;"></i>
                    <h5 class="mb-0 fw-bold" style="font-size: 0.85rem;">گزارش موجودی انبار</h5>
                </div>
                <span class="badge bg-light text-dark" style="font-size: 0.75rem;">
                    مجموع: @(ViewBag.TotalQuantity != null ? ((int)ViewBag.TotalQuantity).ToString("N0") : "0")
                </span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" width="20%" class="text-start ps-4">کد یکتا</th>
                                <th scope="col" width="30%" class="text-start ps-4">محل نگهداری</th>
                                <th scope="col" width="50%" class="text-start">کالا</th>
                                <th scope="col" width="20%" class="text-end pe-4">موجودی</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr class="align-middle">
                                    <td class="text-center align-middle">
                                        <div class="d-flex flex-wrap justify-content-center gap-1 small">
                                            @foreach (var code in item.UniqueCodes)
                                            {
                                                <span class="badge bg-secondary bg-opacity-10 text-secondary">@code</span>
                                            }
                                        </div>
                                    </td>

                                    <td class="text-start ps-4" title="@($"{item.WarehouseName} - {item.ZoneName ?? "-"} - {item.SectionName ?? "-"}")">
                                        <div class="small">
                                            @if (!string.IsNullOrEmpty(item.ZoneName) || !string.IsNullOrEmpty(item.SectionName))
                                            {
                                                <span>@item.WarehouseName - @(item.ZoneName ?? "-") - @(item.SectionName ?? "-")</span>
                                            }
                                            else
                                            {
                                                <span>موقعیت نامشخص</span>
                                            }
                                        </div>
                                    </td>
                                    <td class="text-start">
                                        <div class="small">
                                            @item.CategoryName - @item.GroupName - @item.StatusName - @item.ProductName
                                        </div>
                                    </td>
                                    <td class="text-end pe-4 fw-bold">
                                        <span class="badge bg-primary bg-opacity-10 text-primary">
                                            @((item.Quantity).ToString("N0"))
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}
else if ((ViewBag.SearchPerformed == true) && Model?.Items != null && !Model.Items.Any())
{
    <div class="alert alert-info mt-3 text-center py-2" dir="rtl">
        <i class="fas fa-box-open fa-1x mb-2 d-block"></i>
        <h5 class="fw-semibold" style="font-size: 0.9rem;">موردی برای نمایش وجود ندارد</h5>
        <p class="text-muted mb-0" style="font-size: 0.8rem;">هیچ آیتمی با فیلترهای انتخاب شده یافت نشد.</p>
    </div>
}
else
{
    <div class="alert alert-warning mt-3 text-center py-2" dir="rtl">
        <i class="fas fa-info-circle fa-1x mb-2 d-block"></i>
        <h5 class="fw-semibold" style="font-size: 0.9rem;">لطفاً ابتدا فیلترها را انتخاب کنید</h5>
        <p class="text-muted mb-0" style="font-size: 0.8rem;">برای مشاهده گزارش، باید ابتدا پارامترهای فیلتر را تنظیم کنید.</p>
    </div>
}


@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="~/lib/select2/js/select2.min.js"></script>
    <script src="~/lib/bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/MenuJs.js"></script>
    <script>
        const BASE_URL = '/WarehouseManagement/InventoryReport/';
        const warehousesList = @Html.Raw(JsonSerializer.Serialize(
        ((SelectList)ViewBag.Warehouses).Cast<SelectListItem>()
        .Select(w => new { value = w.Value, text = w.Text })
    ));

        // ذخیره مقادیر select2 قبل از جستجو
        const selectCache = {};
        let currentFormState = {};

        function cacheSelectValues(container = document) {
            $(container).find('.select2').each(function () {
                selectCache[this.id] = $(this).val();
                console.log(`🔹 Caching value for ${this.id}:`, selectCache[this.id]);
            });
        }

        function restoreSelectValues(container = document) {
            $(container).find('.select2').each(function () {
                const cachedVal = selectCache[this.id];
                if (cachedVal === undefined || cachedVal === null) return;

                const $this = $(this);
                const isMultiple = $this.prop('multiple');

                if (isMultiple) {
                    const values = Array.isArray(cachedVal) ? cachedVal : [cachedVal];
                    values.forEach(val => {
                        if ($this.find(`option[value="${val}"]`).length === 0) {
                            const newOption = new Option(val, val, true, true);
                            $this.append(newOption);
                        }
                    });
                    $this.val(values).trigger('change');
                } else {
                    if ($this.find(`option[value="${cachedVal}"]`).length === 0) {
                        const newOption = new Option(cachedVal, cachedVal, true, true);
                        $this.append(newOption);
                    }
                    $this.val(cachedVal).trigger('change');
                }

                console.log(`🔹 Restored value for ${this.id}:`, $this.val());
            });
        }

        function initializeSelect2(container = document) {
            $(container).find('.select2:not(.select2-hidden-accessible)').each(function () {
                const $this = $(this);
                const selectedValue = $this.val();
                const isMultiple = $this.prop('multiple');

                console.log('-----------------------------');
                console.log('Initializing Select2 for:', this.id);
                console.log('Current selectedValue:', selectedValue);
                console.log('Is multiple:', isMultiple);
                console.log('Existing options:', $this.find('option').map((i, o) => o.value).get());

                $this.select2({
                    placeholder: $this.attr('placeholder') || 'انتخاب کنید',
                    allowClear: true,
                    width: '100%',
                    dir: 'rtl',
                    minimumResultsForSearch: 1,
                    language: {
                        noResults: () => 'نتیجه‌ای یافت نشد',
                        searching: () => 'در حال جستجو...',
                        inputTooShort: () => 'لطفاً حداقل یک کاراکتر وارد کنید'
                    }
                });

                // اضافه کردن optionهای missing
                if (selectedValue) {
                    const values = isMultiple ? (Array.isArray(selectedValue) ? selectedValue : [selectedValue]) : [selectedValue];
                    values.forEach(val => {
                        if ($this.find(`option[value="${val}"]`).length === 0) {
                            const newOption = new Option(val, val, true, true);
                            $this.append(newOption);
                        }
                    });
                    $this.val(isMultiple ? values : selectedValue).trigger('change');
                }

                console.log('After setting value, select val():', $this.val());
                console.log('-----------------------------');
            });

            restoreSelectValues(container);
        }

        function getWarehouseOptions() {
            if (!Array.isArray(warehousesList)) return '<option value="">هیچ انباری یافت نشد</option>';
            return warehousesList.map(w => `<option value="${w.value}">${w.text}</option>`).join('');
        }

        async function loadGroups(categoryId) {
            const groupSelect = $('#GroupId');
            const statusSelect = $('#StatusId');
            const productSelect = $('#ProductId');
            const uniqueCodesSelect = $('#UniqueCodes');

            groupSelect.prop('disabled', true).html('<option>در حال بارگذاری...</option>').trigger('change');
            statusSelect.prop('disabled', true).html('<option>ابتدا گروه را انتخاب کنید</option>').trigger('change');
            productSelect.prop('disabled', true).html('<option>ابتدا وضعیت را انتخاب کنید</option>').trigger('change');
            uniqueCodesSelect.prop('disabled', true).html('<option>ابتدا کالا را انتخاب کنید</option>').trigger('change');

            if (!categoryId) return;

            try {
                const response = await fetch(`${BASE_URL}GetGroupsByCategoryId?categoryId=${categoryId}`);
                const data = await response.json();
                groupSelect.empty().append('<option value="">همه گروه‌ها</option>');
                data.forEach(g => groupSelect.append(new Option(g.text, g.value)));
                groupSelect.prop('disabled', false).trigger('change');
            } catch (err) {
                console.error(err);
                alert('خطا در بارگذاری گروه‌ها');
            }
        }

        async function loadStatuses(groupId) {
            const statusSelect = $('#StatusId');
            const productSelect = $('#ProductId');
            const uniqueCodesSelect = $('#UniqueCodes');

            statusSelect.prop('disabled', true).html('<option>در حال بارگذاری...</option>').trigger('change');
            productSelect.prop('disabled', true).html('<option>ابتدا وضعیت را انتخاب کنید</option>').trigger('change');
            uniqueCodesSelect.prop('disabled', true).html('<option>ابتدا کالا را انتخاب کنید</option>').trigger('change');

            if (!groupId) return;

            try {
                const response = await fetch(`${BASE_URL}GetStatusesByGroupId?groupId=${groupId}`);
                const data = await response.json();
                statusSelect.empty().append('<option value="">همه وضعیت‌ها</option>');
                data.forEach(s => statusSelect.append(new Option(s.text, s.value)));
                statusSelect.prop('disabled', false).trigger('change');
            } catch (err) {
                console.error(err);
                alert('خطا در بارگذاری وضعیت‌ها');
            }
        }

        async function loadProducts(statusId) {
            const productSelect = $('#ProductId');
            const uniqueCodesSelect = $('#UniqueCodes');

            productSelect.prop('disabled', true).html('<option>در حال بارگذاری...</option>').trigger('change');
            uniqueCodesSelect.prop('disabled', true).html('<option>ابتدا کالا را انتخاب کنید</option>').trigger('change');

            if (!statusId) return;

            try {
                const response = await fetch(`${BASE_URL}GetProductsByStatusId?statusId=${statusId}`);
                const data = await response.json();
                productSelect.empty().append('<option value="">همه کالاها</option>');
                data.forEach(p => productSelect.append(new Option(p.text, p.value)));
                productSelect.prop('disabled', false).trigger('change');
            } catch (err) {
                console.error(err);
                alert('خطا در بارگذاری کالاها');
            }
        }

        async function loadUniqueCodes(productId) {
            const uniqueCodesSelect = $('#UniqueCodes');
            uniqueCodesSelect.prop('disabled', true).html('<option>در حال بارگذاری...</option>').trigger('change');

            if (!productId) return;

            try {
                const response = await fetch(`${BASE_URL}GetUniqueCodes?productId=${productId}`);
                const data = await response.json();
                uniqueCodesSelect.empty().append('<option value="">همه کدهای یکتا</option>');
                data.forEach(code => uniqueCodesSelect.append(new Option(code.text, code.id)));
                uniqueCodesSelect.prop('disabled', false).trigger('change');

                restoreSelectValues('#UniqueCodes');
            } catch (err) {
                console.error(err);
                uniqueCodesSelect.html('<option>خطا در بارگذاری</option>').trigger('change');
            }
        }

        async function loadZones(selectElement) {
            const warehouseId = selectElement.value;
            const index = $(selectElement).data('index');
            const zoneSelect = $(`select[name="Warehouses[${index}].ZoneIds"]`);
            const sectionSelect = $(`select[name="Warehouses[${index}].SectionIds"]`);

            zoneSelect.prop('disabled', true).html('<option>در حال بارگذاری...</option>').trigger('change');
            sectionSelect.prop('disabled', true).html('<option>ابتدا منطقه را انتخاب کنید</option>').trigger('change');

            if (!warehouseId) return;

            try {
                const response = await fetch(`${BASE_URL}GetZonesByWarehouseId?warehouseId=${warehouseId}`);
                const data = await response.json();
                zoneSelect.empty().append('<option value="">انتخاب مناطق</option>');
                data.forEach(z => zoneSelect.append(new Option(z.text, z.value)));
                zoneSelect.prop('disabled', false).trigger('change');
            } catch (err) {
                console.error(err);
                zoneSelect.html('<option>خطا در بارگذاری</option>').trigger('change');
            }
        }

        async function loadSections(selectElement) {
            const zoneIds = Array.from(selectElement.selectedOptions).map(o => o.value);
            const index = $(selectElement).data('index');
            const sectionSelect = $(`select[name="Warehouses[${index}].SectionIds"]`);

            sectionSelect.prop('disabled', true).html('<option>در حال بارگذاری...</option>').trigger('change');
            if (!zoneIds.length) return;

            try {
                const response = await fetch(`${BASE_URL}GetSectionsByZoneIds?zoneIds=${zoneIds.join(',')}`);
                const data = await response.json();
                sectionSelect.empty().append('<option value="">انتخاب بخش‌ها</option>');
                data.forEach(s => sectionSelect.append(new Option(s.text, s.value)));
                sectionSelect.prop('disabled', false).trigger('change');
            } catch (err) {
                console.error(err);
                sectionSelect.html('<option>خطا در بارگذاری</option>').trigger('change');
            }
        }

        async function addWarehouseFilter(warehouseId = null, zoneId = null, sectionId = null) {
            const container = $('#warehouseFiltersContainer');
            const newIndex = container.children().length;
            const optionsHtml = getWarehouseOptions();

            const filterHtml = `
                <div class="warehouse-filter-group p-3 border rounded mb-3">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">انبار</label>
                            <select name="Warehouses[${newIndex}].WarehouseId" class="form-select select2" data-index="${newIndex}" onchange="loadZones(this)">
                                <option value="">انتخاب انبار</option>
                                ${optionsHtml}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">قسمت</label>
                            <select name="Warehouses[${newIndex}].ZoneIds" class="form-select select2" data-index="${newIndex}" onchange="loadSections(this)" disabled multiple>
                                <option value="">ابتدا انبار را انتخاب کنید</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">بخش‌ها</label>
                            <select name="Warehouses[${newIndex}].SectionIds" class="form-select select2" data-index="${newIndex}" disabled multiple>
                                <option value="">ابتدا قسمت را انتخاب کنید</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-end mt-2">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeWarehouseFilter(this)">
                            <i class="fas fa-times me-1"></i> حذف
                        </button>
                    </div>
                </div>
            `;
            const newFilter = $(filterHtml).appendTo(container);
            initializeSelect2(newFilter);

            if (warehouseId) {
                const warehouseSelect = newFilter.find(`select[name="Warehouses[${newIndex}].WarehouseId"]`);
                warehouseSelect.val(warehouseId).trigger('change');
                await loadZones(warehouseSelect[0]);

                if (zoneId) {
                    const zoneSelect = newFilter.find(`select[name="Warehouses[${newIndex}].ZoneIds"]`);
                    zoneSelect.val([zoneId]).trigger('change');
                    await loadSections(zoneSelect[0]);

                    if (sectionId) {
                        const sectionSelect = newFilter.find(`select[name="Warehouses[${newIndex}].SectionIds"]`);
                        sectionSelect.val([sectionId]).trigger('change');
                    }
                }
            }
        }

        function removeWarehouseFilter(button) {
            const container = $('#warehouseFiltersContainer');
            if (container.children('.warehouse-filter-group').length <= 1) {
                alert('حداقل یک فیلتر انبار باید باقی بماند.');
                return;
            }
            const filterGroup = $(button).closest('.warehouse-filter-group');
            filterGroup.find('select.select2').select2('destroy');
            filterGroup.remove();

            container.children('.warehouse-filter-group').each(function (index) {
                $(this).find('select[name$="WarehouseId"]').attr('name', `Warehouses[${index}].WarehouseId`).data('index', index);
                $(this).find('select[name$="ZoneIds"]').attr('name', `Warehouses[${index}].ZoneIds`).data('index', index);
                $(this).find('select[name$="SectionIds"]').attr('name', `Warehouses[${index}].SectionIds`).data('index', index);
            });
        }

        $(document).ready(async function () {
            initializeSelect2();

            $('#inventoryReportForm').on('submit', function () {
                cacheSelectValues();
            });

            // Restore state after page load
            await restoreSelectValues();

            $('#UniqueCodes').on('select2:select', async function (e) {
                const selectedCode = e.params.data.id;
                try {
                    const response = await fetch(`${BASE_URL}GetUniqueCodeDetails?uniqueCodeId=${selectedCode}`);
                    const data = await response.json();
                    addWarehouseFilter(data.sourceWarehouseId, data.sourceZoneId, data.sourceSectionId);
                } catch (err) {
                    console.error(err);
                    alert('خطا در بارگذاری جزئیات کد یکتا.');
                }
            });
        });
    </script>
}
