@using IMS.Application.WarehouseManagement.DTOs
@model IMS.Models.ProMan.ConversionCreateViewModel
@{
    ViewData["Title"] = "ویرایش سند تبدیل";
   Layout = "~/Areas/WarehouseManagement/Views/Shared/_MyLayout.cshtml";
}


<link href="~/lib/select2/css/select2.min.css" rel="stylesheet" />
<link href="~/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="~/lib/persian-datepicker/persian-datepicker.min.css" rel="stylesheet" />
<link href="~/lib/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet" />


<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">


<style>
    select.form-select[dir="rtl"],
    select.form-select.text-end {
        direction: rtl;
        text-align: right;
        padding-right: 1rem;
        padding-left: 2rem;
        background-position: left 0.75rem center;
        background-size: 16px 16px;
        background-repeat: no-repeat;
    }

    select.form-select,
    select.select2-hidden-accessible {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
    }

    .table-sm-custom {
        font-size: 0.85rem;
    }

        .table-sm-custom .form-select,
        .table-sm-custom .form-control {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            height: auto;
        }

        .table-sm-custom label,
        .table-sm-custom .accordion-button {
            font-size: 0.82rem;
        }

        .table-sm-custom .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .table-sm-custom .accordion-body {
            padding: 0.5rem;
        }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .alert-danger {
        font-size: 0.85rem;
    }
</style>


<div class="card border-0 shadow-sm" dir="rtl">
    <div class="card-header py-1 d-flex justify-content-between align-items-center" style="background-color: #1a4959; color: white;">
        <div class="d-flex align-items-center">
            <i class="fas fa-edit ms-1" style="font-size: 0.85rem;"></i>
            <h5 class="mb-0 fw-bold" style="font-size: 0.9rem;">@ViewData["Title"]</h5>
        </div>
    </div>

    <div class="card-body p-2">
        <form asp-action="Edit" method="post" id="conversionForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="DocumentId" />

            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger small py-2 px-3 mb-3 text-end" role="alert">
                    <strong class="d-block mb-1">خطا!</strong>
                    @Html.ValidationSummary(true)
                </div>
            }

            <div class="row g-2 mb-3">
                <div class="col-md-3">
                    <label asp-for="DateString" class="form-label fw-bold small text-end w-100">تاریخ</label>
                    <div class="input-group input-group-sm">
                        <input asp-for="DateString" class="form-control persian-datepicker text-end" placeholder="تاریخ را انتخاب کنید" aria-describedby="date-icon" />
                        <span class="input-group-text" id="date-icon"><i class="bi bi-calendar3"></i></span>
                    </div>
                    <span asp-validation-for="DateString" class="text-danger small d-block text-end"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="DocumentNumber" class="form-label fw-bold small text-end w-100">شماره سند</label>
                    <div class="input-group input-group-sm">
                        <input asp-for="DocumentNumber" class="form-control text-end" readonly aria-describedby="doc-icon" />
                        <span class="input-group-text" id="doc-icon"><i class="bi bi-file-earmark-text"></i></span>
                    </div>
                    <span asp-validation-for="DocumentNumber" class="text-danger small d-block text-end"></span>
                </div>
            </div>

            <hr class="my-3" />

            
            <!-- Consumed Items Section -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-light-primary d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-black">
                        <i class="fas fa-box-open me-2"></i>کالاهای مصرفی
                    </h6>
                    <button type="button" id="addConsumedItem" class="btn btn-sm btn-primary rounded-pill">
                        <i class="bi bi-plus-circle me-2"></i>افزودن کالای مصرفی
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive border rounded-3">
                        <div id="consumedValidationErrors" class="mb-3"></div>
                        <table class="table table-hover mb-0 table-sm-custom" id="consumedItemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center py-2">کالا</th>
                                    <th class="text-center py-2">تعداد</th>
                                    <th class="text-center py-2">محل نگهداری</th>
                                    <th class="text-center py-2">پروژه</th>
                                    <th class="text-center py-2" style="width: 80px;">عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.ConsumedItems != null && Model.ConsumedItems.Any())
                                {
                                    for (int i = 0; i < Model.ConsumedItems.Count; i++)
                                    {
                                        <tr class="align-middle" data-index="@i">
                                            <td>
                                                <div class="accordion border-0" id="productAccordion_@i">
                                                    <div class="accordion-item shadow-sm rounded-3 overflow-hidden border-0">
                                                        <h2 class="accordion-header" id="heading_@i">
                                                            <button class="accordion-button collapsed bg-light-subtle fw-semibold py-2" type="button"
                                                                    data-bs-toggle="collapse" data-bs-target="#productCollapse_@i" aria-expanded="false"
                                                                    aria-controls="productCollapse_@i">
                                                                @if (Model.ConsumedItems[i].ProductId != 0)
                                                                {
                                                                    var category = Model.Categories.FirstOrDefault(c => c.Value == Model.ConsumedItems[i].CategoryId.ToString())?.Text ?? "?";
                                                                    var group = Model.Groups.FirstOrDefault(g => g.Id == Model.ConsumedItems[i].GroupId)?.Name ?? "?";
                                                                    var status = Model.Statuses.FirstOrDefault(s => s.Id == Model.ConsumedItems[i].StatusId)?.Name ?? "?";
                                                                    var product = Model.Products.FirstOrDefault(p => p.Id == Model.ConsumedItems[i].ProductId)?.Name ?? "?";
                                                                    @($"{category} / {group} / {status} / {product}")
                                                                }
                                                                else
                                                                {
                                                                    <text>انتخاب کالا و مشخصات آن</text>
                                                                }
                                                            </button>
                                                        </h2>
                                                        <div id="productCollapse_@i" class="accordion-collapse collapse">
                                                            <div class="accordion-body py-2 px-3">
                                                                <div class="mb-2">
                                                                    <label class="form-label small">دسته‌بندی</label>
                                                                    <select asp-for="ConsumedItems[i].CategoryId" class="form-select form-select-sm shadow-sm category-select text-end" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب دسته‌بندی</option>
                                                                        @foreach (var category in Model.Categories)
                                                                        {
                                                                            <option value="@category.Value" selected="@(category.Value == Model.ConsumedItems[i].CategoryId.ToString())">@category.Text</option>
                                                                        }
                                                                    </select>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label small">گروه</label>
                                                                    <select asp-for="ConsumedItems[i].GroupId" class="form-select form-select-sm shadow-sm group-select" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب گروه</option>
                                                                        @if (Model.ConsumedItems[i].GroupId != 0)
                                                                        {
                                                                            var selectedGroup = Model.Groups.FirstOrDefault(g => g.Id == Model.ConsumedItems[i].GroupId);
                                                                            if (selectedGroup != null)
                                                                            {
                                                                                <option value="@selectedGroup.Id" selected>@selectedGroup.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                </div>

                                                                <div class="mb-2">
                                                                    <label class="form-label small">طبقه</label>
                                                                    <select asp-for="ConsumedItems[i].StatusId" class="form-select form-select-sm shadow-sm status-select" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب طبقه</option>
                                                                        @if (Model.ConsumedItems[i].StatusId != 0)
                                                                        {
                                                                            var selectedStatus = Model.Statuses.FirstOrDefault(s => s.Id == Model.ConsumedItems[i].StatusId);
                                                                            if (selectedStatus != null)
                                                                            {
                                                                                <option value="@selectedStatus.Id" selected>@selectedStatus.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                </div>

                                                                <div class="mb-1">
                                                                    <label class="form-label small">کالا</label>
                                                                    <select asp-for="ConsumedItems[i].ProductId" class="form-select form-select-sm shadow-sm product-select" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب کالا</option>
                                                                        @if (Model.ConsumedItems[i].ProductId != 0)
                                                                        {
                                                                            var selectedProduct = Model.Products.FirstOrDefault(p => p.Id == Model.ConsumedItems[i].ProductId);
                                                                            if (selectedProduct != null)
                                                                            {
                                                                                <option value="@selectedProduct.Id" selected>@selectedProduct.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style="width: 120px;">
                                                <input asp-for="ConsumedItems[i].Quantity" type="number" min="1" class="form-control shadow-sm" />
                                                <span asp-validation-for="ConsumedItems[i].Quantity" class="text-danger small d-block mt-1"></span>
                                            </td>
                                            <td>
                                                <div class="accordion" id="locationAccordion_@i">
                                                    <div class="accordion-item border-0">
                                                        <h2 class="accordion-header">
                                                            <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#locationCollapse_@i">
                                                                @{
                                                                    var warehouse = Model.Warehouses.FirstOrDefault(w => w.Value == Model.ConsumedItems[i].WarehouseId.ToString())?.Text ?? "?";
                                                                    var zone = Model.Zones.FirstOrDefault(z => z.Id == Model.ConsumedItems[i].ZoneId)?.Name ?? "?";
                                                                    var section = Model.Sections.FirstOrDefault(s => s.Id == Model.ConsumedItems[i].SectionId)?.Name ?? "?";
                                                                }
                                                                @($"{warehouse} / {zone} / {section}")
                                                            </button>
                                                        </h2>
                                                        <div id="locationCollapse_@i" class="accordion-collapse collapse">
                                                            <div class="accordion-body p-2">
                                                                <div class="mb-2">
                                                                    <label class="form-label small text-muted mb-1">انبار</label>
                                                                    <select asp-for="ConsumedItems[i].WarehouseId" class="form-select form-select-sm warehouse-select shadow-sm" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب انبار</option>
                                                                        @foreach (var warehouse in Model.Warehouses)
                                                                        {
                                                                            <option value="@warehouse.Value" selected="@(warehouse.Value == Model.ConsumedItems[i].WarehouseId.ToString())">@warehouse.Text</option>
                                                                        }
                                                                    </select>
                                                                    <span asp-validation-for="ConsumedItems[i].WarehouseId" class="text-danger small d-block mt-1"></span>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label small text-muted mb-1">قسمت</label>
                                                                    <select asp-for="ConsumedItems[i].ZoneId" class="form-select form-select-sm zone-select shadow-sm" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب قسمت</option>
                                                                        @if (Model.ConsumedItems[i].ZoneId != 0)
                                                                        {
                                                                            var selectedZone = Model.Zones.FirstOrDefault(z => z.Id == Model.ConsumedItems[i].ZoneId);
                                                                            if (selectedZone != null)
                                                                            {
                                                                                <option value="@selectedZone.Id" selected>@selectedZone.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                    <span asp-validation-for="ConsumedItems[i].ZoneId" class="text-danger small d-block mt-1"></span>
                                                                </div>

                                                                <div>
                                                                    <label class="form-label small text-muted mb-1">بخش</label>
                                                                    <select asp-for="ConsumedItems[i].SectionId" class="form-select form-select-sm section-select shadow-sm" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب بخش</option>
                                                                        @if (Model.ConsumedItems[i].SectionId != 0)
                                                                        {
                                                                            var selectedSection = Model.Sections.FirstOrDefault(s => s.Id == Model.ConsumedItems[i].SectionId);
                                                                            if (selectedSection != null)
                                                                            {
                                                                                <option value="@selectedSection.Id" selected>@selectedSection.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                    <span asp-validation-for="ConsumedItems[i].SectionId" class="text-danger small d-block mt-1"></span>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <select asp-for="ConsumedItems[i].ProjectId" class="form-select form-select-sm text-end" dir="rtl">
                                                    <option value="">بدون پروژه</option>
                                                    @foreach (var project in Model.Projects)
                                                    {
                                                        <option value="@project.Value" selected="@(project.Value == Model.ConsumedItems[i].ProjectId?.ToString())">@project.Text</option>
                                                    }
                                                </select>
                                                <span asp-validation-for="ConsumedItems[i].ProjectId" class="text-danger small d-block mt-1"></span>
                                            </td>
                                            <td class="text-center">
                                                <div class="d-flex justify-content-center gap-2">
                                                    <button type="button" class="btn btn-outline-success btn-sm save-item rounded-circle" title="ثبت" aria-label="ثبت آیتم">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger btn-sm remove-item rounded-circle" title="حذف" aria-label="حذف آیتم">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>



            <!-- Produced Items Section -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-light-success d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-black">
                        <i class="fas fa-industry me-2"></i>کالاهای تولیدی
                    </h6>
                  
                </div>
                <div class="card-body">
                    <div class="table-responsive border rounded-3">
                        <div id="producedValidationErrors" class="mb-3"></div>
                        <table class="table table-hover table-sm mb-0 table-sm-custom" id="producedItemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center py-2">کالا</th>
                                    <th class="text-center py-2">تعداد</th>
                                    <th class="text-center py-2">محل نگهداری</th>
                                    <th class="text-center py-2">پروژه</th>
                                    <th class="text-center py-2" style="width: 80px;">عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.ProducedItems != null && Model.ProducedItems.Any())
                                {
                                    for (int i = 0; i < Model.ProducedItems.Count; i++)
                                    {
                                        <tr class="align-middle" data-index="@i">
                                            <td>
                                                <div class="accordion" id="producedProductAccordion_@i">
                                                    <div class="accordion-item border-0">
                                                        <h2 class="accordion-header">
                                                            <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#producedProductCollapse_@i">
                                                                @if (Model.ProducedItems[i].ProductId != 0)
                                                                {
                                                                    var category = Model.Categories.FirstOrDefault(c => c.Value == Model.ProducedItems[i].CategoryId.ToString())?.Text ?? "?";
                                                                    var group = Model.Groups.FirstOrDefault(g => g.Id == Model.ProducedItems[i].GroupId)?.Name ?? "?";
                                                                    var status = Model.Statuses.FirstOrDefault(s => s.Id == Model.ProducedItems[i].StatusId)?.Name ?? "?";
                                                                    var product = Model.Products.FirstOrDefault(p => p.Id == Model.ProducedItems[i].ProductId)?.Name ?? "?";
                                                                    @($"{category} / {group} / {status} / {product}")
                                                                }
                                                                else
                                                                {
                                                                    <text>انتخاب کالا و مشخصات آن</text>
                                                                }
                                                            </button>
                                                        </h2>
                                                        <div id="producedProductCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#producedProductAccordion_@i">
                                                            <div class="accordion-body p-2">
                                                                <div class="mb-2">
                                                                    <label class="form-label small">دسته‌بندی</label>
                                                                    <select asp-for="ProducedItems[i].CategoryId" class="form-select form-select-sm shadow-sm category-select text-end" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب دسته‌بندی</option>
                                                                        @foreach (var category in Model.Categories)
                                                                        {
                                                                            <option value="@category.Value" selected="@(category.Value == Model.ProducedItems[i].CategoryId.ToString())">@category.Text</option>
                                                                        }
                                                                    </select>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label small">گروه</label>
                                                                    <select asp-for="ProducedItems[i].GroupId" class="form-select form-select-sm shadow-sm group-select" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب گروه</option>
                                                                        @if (Model.ProducedItems != null && Model.ProducedItems[i].GroupId != 0)
                                                                        {
                                                                            var selectedGroup = Model.Groups.FirstOrDefault(g => g.Id == Model.ProducedItems[i].GroupId);
                                                                            if (selectedGroup != null)
                                                                            {
                                                                                <option value="@selectedGroup.Id" selected>@selectedGroup.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                </div>

                                                                <div class="mb-2">
                                                                    <label class="form-label small">طبقه</label>
                                                                    <select asp-for="ProducedItems[i].StatusId" class="form-select form-select-sm shadow-sm status-select" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب طبقه</option>
                                                                        @if (Model.ProducedItems != null && Model.ProducedItems[i].StatusId != 0)
                                                                        {
                                                                            var selectedStatus = Model.Statuses.FirstOrDefault(s => s.Id == Model.ProducedItems[i].StatusId);
                                                                            if (selectedStatus != null)
                                                                            {
                                                                                <option value="@selectedStatus.Id" selected>@selectedStatus.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                </div>

                                                                <div class="mb-1">
                                                                    <label class="form-label small">کالا</label>
                                                                    <select asp-for="ProducedItems[i].ProductId" class="form-select form-select-sm shadow-sm product-select" data-index="@i" dir="rtl">
                                                                        <option value="">انتخاب کالا</option>
                                                                        @if (Model.ProducedItems != null && Model.ProducedItems[i].ProductId != 0)
                                                                        {
                                                                            var selectedProduct = Model.Products.FirstOrDefault(p => p.Id == Model.ProducedItems[i].ProductId);
                                                                            if (selectedProduct != null)
                                                                            {
                                                                                <option value="@selectedProduct.Id" selected>@selectedProduct.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style="width: 120px;">
                                                <input asp-for="ProducedItems[i].Quantity" type="number" min="1" class="form-control shadow-sm" />
                                                <span asp-validation-for="ProducedItems[i].Quantity" class="text-danger small d-block mt-1"></span>
                                            </td>
                                            <td>
                                                <div class="accordion" id="producedLocationAccordion_@i">
                                                    <div class="accordion-item border-0">
                                                        <h2 class="accordion-header">
                                                            <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#producedLocationCollapse_@i">
                                                                @{
                                                                    var warehouse = Model.Warehouses.FirstOrDefault(w => w.Value == Model.ProducedItems[i].WarehouseId.ToString())?.Text ?? "?";
                                                                    var zone = Model.Zones.FirstOrDefault(z => z.Id == Model.ProducedItems[i].ZoneId)?.Name ?? "?";
                                                                    var section = Model.Sections.FirstOrDefault(s => s.Id == Model.ProducedItems[i].SectionId)?.Name ?? "?";
                                                                }
                                                                @($"{warehouse} / {zone} / {section}")
                                                            </button>
                                                        </h2>
                                                        <div id="producedLocationCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#producedLocationAccordion_@i">
                                                            <div class="accordion-body p-2">
                                                                <div class="mb-2">
                                                                    <label class="form-label small text-muted mb-1">انبار</label>
                                                                    <select asp-for="ProducedItems[i].WarehouseId" class="form-select form-select-sm warehouse-select shadow-sm" data-index="produced_@i" dir="rtl">
                                                                        <option value="">انتخاب انبار</option>
                                                                        @foreach (var warehouse in Model.Warehouses)
                                                                        {
                                                                            <option value="@warehouse.Value" selected="@(warehouse.Value == Model.ProducedItems[i].WarehouseId.ToString())">@warehouse.Text</option>
                                                                        }
                                                                    </select>
                                                                    <span asp-validation-for="ProducedItems[i].WarehouseId" class="text-danger small d-block mt-1"></span>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="form-label small text-muted mb-1">قسمت</label>
                                                                    <select asp-for="ProducedItems[i].ZoneId" class="form-select form-select-sm zone-select shadow-sm" data-index="produced_@i" dir="rtl">
                                                                        <option value="">انتخاب قسمت</option>
                                                                        @if (Model.ProducedItems != null && Model.ProducedItems[i].ZoneId != 0)
                                                                        {
                                                                            var selectedZone = Model.Zones.FirstOrDefault(z => z.Id == Model.ProducedItems[i].ZoneId);
                                                                            if (selectedZone != null)
                                                                            {
                                                                                <option value="@selectedZone.Id" selected>@selectedZone.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                    <span asp-validation-for="ProducedItems[i].ZoneId" class="text-danger small d-block mt-1"></span>
                                                                </div>
                                                                <div>
                                                                    <label class="form-label small text-muted mb-1">بخش</label>
                                                                    <select asp-for="ProducedItems[i].SectionId" class="form-select form-select-sm section-select shadow-sm" data-index="produced_@i" dir="rtl">
                                                                        <option value="">انتخاب بخش</option>
                                                                        @if (Model.ProducedItems != null && Model.ProducedItems[i].SectionId != 0)
                                                                        {
                                                                            var selectedSection = Model.Sections.FirstOrDefault(s => s.Id == Model.ProducedItems[i].SectionId);
                                                                            if (selectedSection != null)
                                                                            {
                                                                                <option value="@selectedSection.Id" selected>@selectedSection.Name</option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                    <span asp-validation-for="ProducedItems[i].SectionId" class="text-danger small d-block mt-1"></span>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <select asp-for="ProducedItems[i].ProjectId" class="form-select form-select-sm text-end" dir="rtl">
                                                    <option value="">بدون پروژه</option>
                                                    @foreach (var project in Model.Projects)
                                                    {
                                                        <option value="@project.Value" selected="@(project.Value == Model.ProducedItems[i].ProjectId?.ToString())">@project.Text</option>
                                                    }
                                                </select>
                                                <span asp-validation-for="ProducedItems[i].ProjectId" class="text-danger small d-block mt-1"></span>
                                            </td>
                                            <td class="text-center">
                                                <div class="d-flex justify-content-center gap-2">
                                                    <button type="button" class="btn btn-outline-success btn-sm save-item rounded-circle" title="ثبت" aria-label="ثبت آیتم">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger btn-sm remove-item rounded-circle" title="حذف" aria-label="حذف آیتم">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <hr class="my-3" />

            <div class="d-flex justify-content-start gap-2 mt-3">
                <a asp-action="Index" class="btn btn-sm btn-secondary px-3 hide-on-print">بازگشت</a>
                <button type="submit" class="btn btn-sm btn-success px-3 hide-on-print">ثبت تغییرات</button>
            </div>
        </form>
    </div>
</div>
@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/select2/js/select2.min.js"></script>
    <script src="~/lib/persian-datepicker/persian-datepicker.min.js"></script>
    <script src="~/js/MenuJs.js"></script>

    <script>
        // داده‌های سرور به صورت JSON به متغیرهای جاوااسکریپت
        var categoriesJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Categories));
        var groupsJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Groups));
        var statusesJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Statuses));
        var productsJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Products));
        var warehousesJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Warehouses));
        var projectsJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Projects));

        // تابع کمکی ساخت options از آرایه
        function generateOptions(items, selectedValue = '') {
            var html = '';
            items.forEach(function(item) {
                var value = item.Value !== undefined ? item.Value : item.Id;
                var text = item.Text !== undefined ? item.Text : item.Name;
                var selected = (value == selectedValue) ? 'selected' : '';
                html += `<option value="${value}" ${selected}>${text}</option>`;
            });
            return html;
        }

           $(document).ready(function () {
            // داده‌های سرور به صورت JSON به متغیرهای جاوااسکریپت
            var categoriesJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Categories));
            var groupsJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Groups));
            var statusesJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Statuses));
            var productsJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Products));
            var warehousesJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Warehouses));
            var zonesJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Zones));
            var sectionsJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Sections));
            var projectsJson = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Projects));

            // تابع کمکی ساخت options از آرایه
            function generateOptions(items, selectedValue = '') {
                var html = '';
                items.forEach(function(item) {
                    var value = item.Value !== undefined ? item.Value : item.Id;
                    var text = item.Text !== undefined ? item.Text : item.Name;
                    var selected = (value == selectedValue) ? 'selected' : '';
                    html += `<option value="${value}" ${selected}>${text}</option>`;
                });
                return html;
            }

            // مقداردهی اولیه برای ردیف‌های موجود (ویرایش) - بخش کالاهای مصرفی
            $('#consumedItemsTable tbody tr').each(function () {
                var $row = $(this);

                // بخش سلسله مراتب کالا
                var selectedCategory = $row.find('.category-select').val();
                if (selectedCategory) {
                    var filteredGroups = groupsJson.filter(g => g.CategoryId == selectedCategory);
                    var selectedGroup = $row.find('.group-select').val();
                    $row.find('.group-select').html(generateOptions(filteredGroups, selectedGroup));
                }

                var selectedGroup = $row.find('.group-select').val();
                if (selectedGroup) {
                    var filteredStatuses = statusesJson.filter(s => s.GroupId == selectedGroup);
                    var selectedStatus = $row.find('.status-select').val();
                    $row.find('.status-select').html(generateOptions(filteredStatuses, selectedStatus));
                }

                var selectedStatus = $row.find('.status-select').val();
                if (selectedStatus) {
                    var filteredProducts = productsJson.filter(p => p.StatusId == selectedStatus);
                    var selectedProduct = $row.find('.product-select').val();
                    $row.find('.product-select').html(generateOptions(filteredProducts, selectedProduct));
                }

                // بخش سلسله مراتب انبار
                var selectedWarehouse = $row.find('.warehouse-select').val();
                if (selectedWarehouse) {
                    var filteredZones = zonesJson.filter(z => z.WarehouseId == selectedWarehouse);
                    var selectedZone = $row.find('.zone-select').val();
                    $row.find('.zone-select').html(generateOptions(filteredZones, selectedZone));
                }

                var selectedZone = $row.find('.zone-select').val();
                if (selectedZone) {
                    var filteredSections = sectionsJson.filter(s => s.ZoneId == selectedZone);
                    var selectedSection = $row.find('.section-select').val();
                    $row.find('.section-select').html(generateOptions(filteredSections, selectedSection));
                }
            });

            // رویداد تغییر دسته‌بندی (کالا)
            $('#consumedItemsTable').on('change', '.category-select', function () {
                var $row = $(this).closest('tr');
                var selectedCategoryId = $(this).val();
                var $groupSelect = $row.find('.group-select');

                var currentSelectedGroup = $groupSelect.val();

                if (!selectedCategoryId) {
                    $groupSelect.html('<option value="">انتخاب گروه</option>');
                    return;
                }

                var filteredGroups = groupsJson.filter(g => g.CategoryId == selectedCategoryId);
                var options = '<option value="">انتخاب کنید</option>';

                filteredGroups.forEach(function(group) {
                    options += '<option value="' + group.Id + '">' + group.Name + '</option>';
                });

                $groupSelect.html(options);

                if (currentSelectedGroup && filteredGroups.some(g => g.Id == currentSelectedGroup)) {
                    $groupSelect.val(currentSelectedGroup);
                } else {
                    $groupSelect.val('');
                }
            });

            // رویداد تغییر گروه (کالا)
            $('#consumedItemsTable').on('change', '.group-select', function () {
                var $row = $(this).closest('tr');
                var selectedGroupId = $(this).val();
                var $statusSelect = $row.find('.status-select');

                var currentSelectedStatus = $statusSelect.val();

                if (!selectedGroupId) {
                    $statusSelect.html('<option value="">انتخاب وضعیت</option>');
                    return;
                }

                var filteredStatuses = statusesJson.filter(s => s.GroupId == selectedGroupId);
                var options = '<option value="">انتخاب کنید</option>';

                filteredStatuses.forEach(function(status) {
                    options += '<option value="' + status.Id + '">' + status.Name + '</option>';
                });

                $statusSelect.html(options);

                if (currentSelectedStatus && filteredStatuses.some(s => s.Id == currentSelectedStatus)) {
                    $statusSelect.val(currentSelectedStatus);
                } else {
                    $statusSelect.val('');
                }
            });

            // رویداد تغییر وضعیت (کالا)
            $('#consumedItemsTable').on('change', '.status-select', function () {
                var $row = $(this).closest('tr');
                var selectedStatusId = $(this).val();
                var $productSelect = $row.find('.product-select');

                var currentSelectedProduct = $productSelect.val();

                if (!selectedStatusId) {
                    $productSelect.html('<option value="">انتخاب کالا</option>');
                    return;
                }

                var filteredProducts = productsJson.filter(p => p.StatusId == selectedStatusId);
                var options = '<option value="">انتخاب کنید</option>';

                filteredProducts.forEach(function(product) {
                    options += '<option value="' + product.Id + '">' + product.Name + '</option>';
                });

                $productSelect.html(options);

                if (currentSelectedProduct && filteredProducts.some(p => p.Id == currentSelectedProduct)) {
                    $productSelect.val(currentSelectedProduct);
                } else {
                    $productSelect.val('');
                }
            });

            // رویداد تغییر انبار
            $('#consumedItemsTable').on('change', '.warehouse-select', function () {
                var $row = $(this).closest('tr');
                var selectedWarehouseId = $(this).val();
                var $zoneSelect = $row.find('.zone-select');

                var currentSelectedZone = $zoneSelect.val();

                if (!selectedWarehouseId) {
                    $zoneSelect.html('<option value="">انتخاب قسمت</option>');
                    return;
                }

                var filteredZones = zonesJson.filter(z => z.WarehouseId == selectedWarehouseId);
                var options = '<option value="">انتخاب کنید</option>';

                filteredZones.forEach(function(zone) {
                    options += '<option value="' + zone.Id + '">' + zone.Name + '</option>';
                });

                $zoneSelect.html(options);

                if (currentSelectedZone && filteredZones.some(z => z.Id == currentSelectedZone)) {
                    $zoneSelect.val(currentSelectedZone);
                } else {
                    $zoneSelect.val('');
                }
            });

            // رویداد تغییر قسمت (Zone)
            $('#consumedItemsTable').on('change', '.zone-select', function () {
                var $row = $(this).closest('tr');
                var selectedZoneId = $(this).val();
                var $sectionSelect = $row.find('.section-select');

                var currentSelectedSection = $sectionSelect.val();

                if (!selectedZoneId) {
                    $sectionSelect.html('<option value="">انتخاب بخش</option>');
                    return;
                }

                var filteredSections = sectionsJson.filter(s => s.ZoneId == selectedZoneId);
                var options = '<option value="">انتخاب کنید</option>';

                filteredSections.forEach(function(section) {
                    options += '<option value="' + section.Id + '">' + section.Name + '</option>';
                });

                $sectionSelect.html(options);

                if (currentSelectedSection && filteredSections.some(s => s.Id == currentSelectedSection)) {
                    $sectionSelect.val(currentSelectedSection);
                } else {
                    $sectionSelect.val('');
                }
            });

            // دکمه افزودن کالای مصرفی (افزودن ردیف جدید)
            $('#addConsumedItem').on('click', function () {
                var index = $('#consumedItemsTable tbody tr').length;

                // ساخت html گزینه‌ها قبل از قالب ردیف
                var categoryOptions = generateOptions(categoriesJson);
                var warehouseOptions = generateOptions(warehousesJson);
                var projectOptions = generateOptions(projectsJson);

                var newRow = `
                    <tr class="align-middle" data-index="${index}">
                        <td>
                            <div class="accordion border-0" id="productAccordion_${index}">
                                <div class="accordion-item shadow-sm rounded-3 overflow-hidden border-0">
                                    <h2 class="accordion-header" id="heading_${index}">
                                        <button class="accordion-button collapsed bg-light-subtle fw-semibold py-2" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#productCollapse_${index}" aria-expanded="false"
                                                aria-controls="productCollapse_${index}">
                                            انتخاب کالا و مشخصات آن
                                        </button>
                                    </h2>
                                    <div id="productCollapse_${index}" class="accordion-collapse collapse">
                                        <div class="accordion-body py-2 px-3">
                                            <div class="mb-2">
                                                <label class="form-label small">دسته‌بندی</label>
                                                <select name="ConsumedItems[${index}].CategoryId" class="form-select form-select-sm shadow-sm category-select text-end" dir="rtl">
                                                    <option value="">انتخاب دسته‌بندی</option>
                                                    ${categoryOptions}
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small">گروه</label>
                                                <select name="ConsumedItems[${index}].GroupId" class="form-select form-select-sm shadow-sm group-select" dir="rtl">
                                                    <option value="">انتخاب گروه</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small">طبقه</label>
                                                <select name="ConsumedItems[${index}].StatusId" class="form-select form-select-sm shadow-sm status-select" dir="rtl">
                                                    <option value="">انتخاب طبقه</option>
                                                </select>
                                            </div>
                                            <div class="mb-1">
                                                <label class="form-label small">کالا</label>
                                                <select name="ConsumedItems[${index}].ProductId" class="form-select form-select-sm shadow-sm product-select" dir="rtl">
                                                    <option value="">انتخاب کالا</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td style="width: 120px;">
                            <input name="ConsumedItems[${index}].Quantity" type="number" min="1" class="form-control shadow-sm" value="1" />
                        </td>
                        <td>
                            <div class="accordion" id="locationAccordion_${index}">
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#locationCollapse_${index}">
                                            انتخاب محل نگهداری
                                        </button>
                                    </h2>
                                    <div id="locationCollapse_${index}" class="accordion-collapse collapse">
                                        <div class="accordion-body p-2">
                                            <div class="mb-2">
                                                <label class="form-label small text-muted mb-1">انبار</label>
                                                <select name="ConsumedItems[${index}].WarehouseId" class="form-select form-select-sm warehouse-select shadow-sm" dir="rtl">
                                                    <option value="">انتخاب انبار</option>
                                                    ${warehouseOptions}
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small text-muted mb-1">قسمت</label>
                                                <select name="ConsumedItems[${index}].ZoneId" class="form-select form-select-sm zone-select shadow-sm" dir="rtl">
                                                    <option value="">انتخاب قسمت</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="form-label small text-muted mb-1">بخش</label>
                                                <select name="ConsumedItems[${index}].SectionId" class="form-select form-select-sm section-select shadow-sm" dir="rtl">
                                                    <option value="">انتخاب بخش</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <select name="ConsumedItems[${index}].ProjectId" class="form-select form-select-sm text-end" dir="rtl">
                                <option value="">بدون پروژه</option>
                                ${projectOptions}
                            </select>
                        </td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-2">
                                <button type="button" class="btn btn-outline-success btn-sm save-item rounded-circle" title="ثبت" aria-label="ثبت آیتم">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm remove-item rounded-circle" title="حذف" aria-label="حذف آیتم">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;

                $('#consumedItemsTable tbody').append(newRow);
            });

            // حذف ردیف
            $('#consumedItemsTable').on('click', '.remove-item', function () {
                $(this).closest('tr').remove();
            });

            // همین منطق را برای جدول کالاهای تولیدی (producedItemsTable) نیز اعمال کنید
            // ...
        });
    </script>
}

