@using IMS.Domain.ProcurementManagement.Enums
@using IMS.Models.ProMan
@using System.Reflection
@model PurchaseRequestDetailsViewModel
@{
    ViewData["Title"] = "جزئیات درخواست خرید";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isCompleted = Model.Status == Status.Completed;
}

<link rel="stylesheet" href="~/fontawesome/css/all.min.css" />
<link href="~/vazirmatn/webfonts.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
    .form-label {
        font-size: 0.75rem;
    }

    .input-group-sm {
        font-size: 0.75rem;
    }

    .disabled-content {
        position: relative;
    }

        .disabled-content::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 100;
        }

    .completion-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 101;
        background-color: #1a4959;
        color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    .disabled-row {
        opacity: 0.5;
        user-select: none;
        /* حذف pointer-events از اینجا */
    }

        .disabled-row td:not(:last-child) {
            pointer-events: none; /* فقط سلول‌های غیرعملیاتی غیرکلیک */
        }




</style>

<div class="container-fluid py-3" dir="rtl">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow" style="box-shadow: 0 4px 8px rgba(13, 110, 253, 0.1);">
                <div class="card-header py-2 d-flex justify-content-between align-items-center"
                     style="background-color: #1a4959; color: white;">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-file-invoice me-2"></i> @ViewData["Title"] شماره @Model.RequestNumber
                    </h5>
                    <a href="@Url.Action("Index", "PurchaseRequestTracking")" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-right me-1"></i> بازگشت به لیست
                    </a>
                </div>

                <div class="card-body p-2 @(isCompleted ? "disabled-content" : "")">
                    @if (isCompleted)
                    {
                        <div class="completion-message text-center text-white">
                            <i class="fas fa-check-circle fa-2x mb-2"></i> 
                            <h4 style="font-size: 1.2rem; margin-bottom: 0.25rem;">درخواست خرید تکمیل شده است</h4>
                            <p style="font-size: 0.9rem; margin-bottom: 0;">این درخواست به صورت کامل پردازش شده است.</p>
                        </div>
                    }

                    <div class="row g-3 mb-3">
                        <!-- تاریخ درخواست -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold mb-1 small">
                                    <i class="fas fa-calendar-alt me-1 text-muted"></i> تاریخ درخواست
                                </label>
                                <div class="input-group input-group-sm bg-light rounded p-2">
                                    @Model.RequestDate.ToString("yyyy/MM/dd")
                                </div>
                            </div>
                        </div>

                        <!-- عنوان -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold mb-1 small">
                                    <i class="fas fa-heading me-1 text-muted"></i> عنوان
                                </label>
                                <div class="input-group input-group-sm bg-light rounded p-2">
                                    @Model.Title
                                </div>
                            </div>
                        </div>

                        <!-- وضعیت -->
                        @{
                            var statusDescription = Model.Status.GetType()
                            .GetField(Model.Status.ToString())
                            .GetCustomAttribute<System.ComponentModel.DescriptionAttribute>()?
                            .Description ?? Model.Status.ToString();
                        }
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label fw-bold mb-1 small">
                                    <i class="fas fa-info-circle me-1 text-muted"></i> وضعیت
                                </label>
                                <div class="input-group input-group-sm bg-light rounded p-2">
                                    @statusDescription
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead style="background-color: #f8f9fa; font-size: 0.82rem;">
                                <tr >
                                    <th class="text-center py-1">کالا</th>
                                    <th class="text-center py-1">تعداد درخواست</th>
                                    <th class="text-center py-1">موجودی کل </th>
                                    <th class="text-center py-1"> در انتظار تامین</th>
                                    <th class="text-center py-1">نیاز به تامین</th>
                                    <th class="text-center py-1">توضیحات</th>
                                    <th class="text-center py-1">عملیات</th>
                                </tr>
                            </thead>
                            <tbody style="font-size: 0.8rem;" >
                                @foreach (var item in Model.Items)
                                {
                                    <tr data-item-id="@item.Id" class="@(item.IsSupplyStopped ? "disabled-row" : "")">
                                        <td class="text-center py-1 align-middle">
                                            @item.CategoryName | @item.GroupName | @item.Status |  @item.ProductName
                                        </td>
                                        <td class="text-center py-1 align-middle quantity">@item.Quantity</td>
                                        <td class="text-center py-1 align-middle total-stock">@item.TotalStock</td>
                                        <td class="text-center py-1 align-middle pending-requests">@item.PendingRequests</td>
                                        <td class="text-center py-1 align-middle need-to-supply">@item.NeedToSupply</td>

                                        <td class="text-center py-1 align-middle">@item.Description</td>
                                        <td class="text-center py-1 align-middle">
                                            <button type="button" class="btn btn-sm btn-icon btn-outline-success rounded-circle me-1" title="درخواست خرید" @(isCompleted ? "disabled" : "")>
                                                <i class="bi bi-cart-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-icon btn-outline-danger rounded-circle toggle-disable-btn" title="توقف تامین" @(isCompleted ? "disabled" : "")>
                                                <i class="bi bi-slash-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>

                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/fontawesome/css/all.min.css" />
    <link href="~/vazirmatn/webfonts.css" rel="stylesheet" />

}

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
               $(document).ready(function() {
          $(".toggle-disable-btn").click(function() {
            var btn = $(this);
            var row = btn.closest("tr");
            var itemId = row.data('item-id');
            var isStopping = !row.hasClass("disabled-row");

            $.ajax({
              url: '@Url.Action("ToggleSupplyStop", "PurchaseRequestTracking", new { area = "ProcurementManagement" })',
              method: 'POST',
              data: { id: itemId, stopSupply: isStopping },
              success: function(response) {
                       if (response.success) {
            if (response.isSupplyStopped) {
                row.addClass("disabled-row");
                btn
                  .attr("title", "فعال کردن تامین")
                  .removeClass("btn-outline-danger")
                  .addClass("btn-outline-success")
                  .html('<i class="bi bi-check-circle"></i>');
                row.find(".supply-status").text("توقف تامین");
            } else {
                row.removeClass("disabled-row");
                btn
                  .attr("title", "توقف تامین")
                  .removeClass("btn-outline-success")
                  .addClass("btn-outline-danger")
                  .html('<i class="bi bi-slash-circle"></i>');
                row.find(".supply-status").text("فعال");
            }

            // غیرفعال کردن همه دکمه‌های ستون عملیات بجز دکمه توقف تامین
            var operationCell = row.find('td:last-child');
            operationCell.find('button').prop('disabled', true);
            operationCell.find('button.toggle-disable-btn').prop('disabled', false);

            // آپدیت بقیه ستون‌ها اگر داده آمد
            if (response.updatedItems) {
                response.updatedItems.forEach(function(updatedItem) {
                    var r = $('tr[data-item-id="' + updatedItem.Id + '"]');
                    if (r.length) {
                        r.find('.quantity').text(updatedItem.Quantity + ' ' + (updatedItem.Unit || ''));
                        r.find('.total-stock').text(updatedItem.TotalStock);
                        r.find('.need-to-supply').text(updatedItem.NeedToSupply);
                    }
                });
            }
        }
         else {
                  alert("خطا: " + response.message);
                }
              },
              error: function() {
                alert("خطا در ارتباط با سرور!");
              }
            });
          });
        });

    </script>
}
